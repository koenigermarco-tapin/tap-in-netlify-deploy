<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="../../manifest.json">
    <meta name="theme-color" content="#c62828">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../../icon-192.png">
    <title>Führungsbewertung - TAP-IN</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- TAP-IN Core Utilities -->
    <link rel="stylesheet" href="../../css/components/toast.css">
    <link rel="stylesheet" href="../../css/components/forms.css">
    <link rel="stylesheet" href="../../css/components/progress.css">
    <script src="../../js/utils/error-handler.js"></script>
    <script src="../../js/utils/validation.js"></script>
    <script src="../../js/utils/security.js"></script>
    <script src="../../js/utils/data-manager.js"></script>
    <style>
        :root {
            --black: #0d0d14;
            --dark-grey: #1a1a24;
            --mid-grey: #2a2a3a;
            --light-grey: #8a8a9a;
            --white: #ffffff;
            --brick-red: #a93226;
            --brick-red-light: #c0392b;
            --blue: #4a6fa5;
            --purple: #6b5b95;
            --blue-glow: rgba(74, 111, 165, 0.3);
            --purple-glow: rgba(107, 91, 149, 0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--black); 
            min-height: 100vh; 
            color: var(--white);
        }
        
        .container { 
            max-width: 700px; 
            margin: 0 auto; 
            padding: 40px 20px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 40px; 
        }
        .logo { 
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem; 
            font-weight: 800; 
            margin-bottom: 25px;
            text-decoration: none;
            color: var(--white);
        }
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--brick-red) 0%, var(--brick-red-light) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1rem;
        }
        h1 { 
            font-size: 1.8rem; 
            font-weight: 800; 
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }
        .subtitle { 
            color: var(--light-grey); 
            font-size: 1rem; 
        }
        
        .progress-container {
            margin-bottom: 40px;
        }
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: var(--light-grey);
        }
        .progress-text span:last-child {
            color: var(--white);
            font-weight: 600;
        }
        .progress-bar { 
            background: var(--mid-grey); 
            border-radius: 10px; 
            height: 8px; 
            overflow: hidden; 
        }
        .progress-fill { 
            background: linear-gradient(90deg, var(--purple), var(--blue)); 
            height: 100%; 
            border-radius: 10px; 
            transition: width 0.4s ease;
            box-shadow: 0 0 20px var(--purple-glow);
        }
        
        .question-card { 
            background: var(--dark-grey); 
            border: 1px solid var(--mid-grey); 
            border-radius: 20px; 
            padding: 35px; 
            margin-bottom: 25px;
            flex: 1;
        }
        .question-category {
            display: inline-block;
            padding: 6px 14px;
            background: linear-gradient(135deg, rgba(107, 91, 149, 0.2) 0%, rgba(74, 111, 165, 0.2) 100%);
            border: 1px solid rgba(107, 91, 149, 0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--light-grey);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .question-text { 
            font-size: 1.35rem; 
            font-weight: 700; 
            margin-bottom: 30px; 
            line-height: 1.4;
            letter-spacing: -0.3px;
        }
        
        .options { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        .option { 
            background: rgba(255,255,255,0.03); 
            border: 2px solid var(--mid-grey); 
            border-radius: 14px; 
            padding: 18px 20px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            display: flex; 
            align-items: center; 
            gap: 15px;
            user-select: none;
            -webkit-user-select: none;
        }
        .option:hover { 
            border-color: var(--purple); 
            background: rgba(107, 91, 149, 0.1); 
        }
        .option.selected { 
            border-color: var(--purple); 
            background: linear-gradient(135deg, rgba(107, 91, 149, 0.15) 0%, rgba(74, 111, 165, 0.15) 100%);
            box-shadow: 0 0 30px rgba(107, 91, 149, 0.2);
        }
        .option-letter { 
            width: 36px; 
            height: 36px; 
            border-radius: 10px; 
            background: var(--mid-grey); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700; 
            font-size: 0.9rem;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .option.selected .option-letter { 
            background: linear-gradient(135deg, var(--purple) 0%, var(--blue) 100%); 
        }
        .option-text { 
            flex: 1; 
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .nav-buttons { 
            display: flex; 
            gap: 15px; 
            justify-content: space-between; 
        }
        .btn { 
            padding: 16px 28px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            border: none; 
        }
        .btn-secondary { 
            background: var(--mid-grey); 
            color: var(--white); 
        }
        .btn-secondary:hover { 
            background: rgba(255,255,255,0.15); 
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--brick-red), var(--brick-red-light)); 
            color: var(--white); 
            flex: 1;
            box-shadow: 0 4px 20px rgba(169, 50, 38, 0.3);
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 30px rgba(169, 50, 38, 0.4); 
        }
        .btn:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
            transform: none !important; 
        }
        
        .results { 
            display: none; 
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .results.show {
            display: flex;
        }
        .results-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--purple) 0%, var(--blue) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            box-shadow: 0 10px 40px var(--purple-glow);
        }
        .results-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
        }
        .results h2 { 
            font-size: 1.1rem; 
            color: var(--light-grey);
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .result-type { 
            font-size: 2.5rem; 
            font-weight: 900; 
            background: linear-gradient(135deg, var(--brick-red-light) 0%, var(--purple) 50%, var(--blue) 100%);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: 15px;
            letter-spacing: -1px;
        }
        .result-desc { 
            color: var(--light-grey); 
            font-size: 1.1rem; 
            margin-bottom: 35px; 
            line-height: 1.7;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        
        
        #questionContainer { display: block; }
        #questionContainer.hide { display: none; }
        #resultsContainer { display: none; }
        #resultsContainer.show { display: flex; flex-direction: column; justify-content: center; flex: 1; }
        
        /* XP & Gamification */
        .xp-bar-container {
            background: var(--dark-grey);
            border: 1px solid var(--mid-grey);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .xp-icon {
            width: 24px;
            height: 24px;
            color: var(--purple);
            flex-shrink: 0;
        }
        .xp-text {
            font-size: 0.85rem;
            color: var(--light-grey);
            font-weight: 600;
        }
        .xp-amount {
            color: var(--white);
            margin-left: auto;
        }
        
        /* Achievement Toast */
        .achievement-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--dark-grey);
            border: 2px solid var(--purple);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(107, 91, 149, 0.4);
            z-index: 10000;
            display: none;
            max-width: 320px;
            animation: slideIn 0.3s ease;
        }
        .achievement-toast.show {
            display: block;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .achievement-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .achievement-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--purple) 0%, var(--blue) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .achievement-icon svg {
            width: 20px;
            height: 20px;
            stroke: white;
        }
        .achievement-title {
            font-weight: 700;
            color: var(--white);
            font-size: 1rem;
        }
        .achievement-desc {
            font-size: 0.85rem;
            color: var(--light-grey);
            margin-bottom: 8px;
        }
        .achievement-xp {
            font-size: 0.8rem;
            color: var(--purple);
            font-weight: 600;
        }
        
        /* Educational Insight */
        .insight-card {
            background: rgba(107, 91, 149, 0.1);
            border: 1px solid rgba(107, 91, 149, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .insight-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .insight-icon {
            width: 24px;
            height: 24px;
            color: var(--purple);
        }
        .insight-title {
            font-weight: 700;
            color: var(--white);
            font-size: 0.95rem;
        }
        .insight-content {
            color: var(--light-grey);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        /* Celebration Animation */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        .celebration.show {
            display: flex;
        }
        .celebration-content {
            text-align: center;
            color: var(--white);
        }
        .celebration-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--purple) 0%, var(--blue) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: pulse 1s ease infinite;
        }
        .celebration-icon svg {
            width: 50px;
            height: 50px;
            stroke: white;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @media (max-width: 480px) { 
            .question-text { font-size: 1.15rem; } 
            .option { padding: 15px; }
            .option-text { font-size: 0.95rem; }
            .result-type { font-size: 2rem; }
            h1 { font-size: 1.5rem; }
            .achievement-toast {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="language-switcher" style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: flex; gap: 5px;">
        <a href="deep-dive-assessment.html" class="lang-btn active" style="padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 12px; background: #10b981; color: #000;">EN</a>
        <a href="deep-dive-assessment-de.html" class="lang-btn" style="padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 12px; background: #2a2a3a; color: #fff;">DE</a>
    </div>
    <script src="../../js/language-switcher.js"></script>


    <div class="container">
        <div class="header">
            <a href="../../index.html" class="logo">
                <div class="logo-icon">T</div>
                <span>TAP-IN</span>
            </a>
            <h1>Entdecke Deine Führungs-DNA</h1>
            <p class="subtitle"><span id="questionCount">15</span> Fragen · ~<span id="timeEstimate">5</span> Minuten · Sofortige Ergebnisse</p>
            <div style="margin-top: 20px; padding: 15px; background: rgba(107, 91, 149, 0.1); border: 1px solid rgba(107, 91, 149, 0.3); border-radius: 12px; max-width: 500px; margin-left: auto; margin-right: auto;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--white);">
                    <input type="checkbox" id="executiveMode" style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleExecutiveMode()">
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">Executive-Modus</div>
                        <div style="font-size: 0.85rem; color: var(--light-grey);">Füge strategische Führungsfragen für C-Suite-Einblicke hinzu</div>
                    </div>
                </label>
            </div>
        </div>
        
        <div class="xp-bar-container" id="xpBar" style="display: none;">
            <svg aria-hidden="true" class="xp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
            </svg>
            <div class="xp-text">XP: <span class="xp-amount" id="xpAmount">0</span></div>
        </div>
        
        <div class="progress-container">
            <div class="progress-text">
                <span>Frage <span id="qNum">1</span> von <span id="totalQuestions">15</span></span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="achievement-toast" id="achievementToast">
            <div class="achievement-header">
                <div class="achievement-icon">
                    <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                </div>
                <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
            </div>
            <div class="achievement-desc" id="achievementDesc"></div>
            <div class="achievement-xp" id="achievementXP">+50 XP</div>
        </div>
        
        <div class="celebration" id="celebration">
            <div class="celebration-content">
                <div class="celebration-icon">
                    <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                </div>
                <h2 style="font-size: 2rem; margin-bottom: 10px;">Bewertung abgeschlossen!</h2>
                <p style="color: var(--light-grey); margin-bottom: 20px;">You've earned <span id="totalXP" style="color: var(--purple); font-weight: 700;">0</span> XP</p>
                <button class="btn btn-primary" onclick="closeCelebration()">Ergebnisse anzeigen</button>
            </div>
        </div>
        
        <div id="questionContainer">
            <div class="question-card">
                <div class="question-category" id="questionCategory">Leadership Style</div>
                <div class="question-text" id="questionText"></div>
                <div class="options" id="optionsContainer"></div>
            </div>
            
            <div class="nav-buttons">
                <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" disabled>Zurück</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>Fortsetzen</button>
            </div>
        </div>
        
        <div id="resultsContainer">
            <div class="results-icon">
                <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                </svg>
            </div>
            <h2>Dein Führungsstil</h2>
            <div class="result-type" id="resultType"></div>
            <p class="result-desc" id="resultDesc"></p>
            <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 30px; max-width: 500px; margin-left: auto; margin-right: auto;">
                <a href="../gym/gym-dashboard-de.html?v=2025-12-15" class="btn btn-primary btn-lg" style="display: inline-flex; align-items: center; gap: 12px;">
                    <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                        <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1"/>
                    </svg>
                    Weiter zu Deinem Gym-Dashboard
                    <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </a>
                <a href="../gym/gym-dashboard-de.html?v=2025-12-15" class="btn btn-secondary btn-lg" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    Dein Profil ansehen
                    <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </a>
                <a href="../../join-team.html" style="padding: 16px 28px; background: rgba(255,255,255,0.05); border: 2px solid var(--mid-grey); border-radius: 12px; color: var(--white); text-decoration: none; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    Einem Team beitreten & Team-Dynamiken sehen
                </a>
                <a href="../hub/team-dashboard.html" style="padding: 16px 28px; background: rgba(107, 91, 149, 0.1); border: 2px solid rgba(107, 91, 149, 0.3); border-radius: 12px; color: var(--white); text-decoration: none; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Team-Dashboard ansehen
                </a>
            </div>
        </div>
    </div>

    <script>
        // Gamification System
        const GAMIFICATION = {
            xp: 0,
            level: 1,
            xpPerQuestion: 10,
            xpForCompletion: 150,
            achievements: {
                'first_start': { icon: 'M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z', name: 'DNA Explorer', desc: 'Started your leadership assessment', xp: 50, unlocked: false },
                'halfway': { icon: 'M13 10V3L4 14h7v7l9-11h-7z', name: 'Halfway Hero', desc: 'Answered 8 questions', xp: 50, unlocked: false },
                'complete': { icon: 'M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z', name: 'Leadership Master', desc: 'Completed the assessment', xp: 50, unlocked: false },
                'speed_demon': { icon: 'M13 10V3L4 14h7v7l9-11h-7z', name: 'Speed Demon', desc: 'Completed in under 5 minutes', xp: 50, unlocked: false }
            },
            startTime: Date.now(),
            load() {
                const saved = localStorage.getItem('tapinGamificationDNA');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.xp = data.xp || 0;
                    this.level = data.level || 1;
                    this.achievements = { ...this.achievements, ...data.achievements };
                }
                this.updateXPBar();
            },
            save() {
                localStorage.setItem('tapinGamificationDNA', JSON.stringify({
                    xp: this.xp,
                    level: this.level,
                    achievements: this.achievements
                }));
            },
            addXP(amount) {
                this.xp += amount;
                this.updateXPBar();
                this.save();
                // Update global XP if exists
                const globalXP = parseInt(localStorage.getItem('totalXP') || '0');
                localStorage.setItem('totalXP', (globalXP + amount).toString());
            },
            updateXPBar() {
                const xpBar = document.getElementById('xpBar');
                const xpAmount = document.getElementById('xpAmount');
                if (xpBar && xpAmount) {
                    xpBar.style.display = 'flex';
                    xpAmount.textContent = this.xp;
                }
            },
            unlockAchievement(key) {
                if (this.achievements[key] && !this.achievements[key].unlocked) {
                    this.achievements[key].unlocked = true;
                    const ach = this.achievements[key];
                    this.addXP(ach.xp);
                    this.showAchievement(ach);
                    this.save();
                }
            },
            showAchievement(ach) {
                const toast = document.getElementById('achievementToast');
                const title = document.getElementById('achievementTitle');
                const desc = document.getElementById('achievementDesc');
                const xp = document.getElementById('achievementXP');
                const icon = toast.querySelector('.achievement-icon svg');
                
                if (toast && title && desc && xp && icon) {
                    title.textContent = ach.name;
                    desc.textContent = ach.desc;
                    xp.textContent = `+${ach.xp} XP`;
                    icon.setAttribute('d', ach.icon);
                    
                    toast.classList.add('show');
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 4000);
                }
            },
            checkSpeedDemon() {
                const elapsed = (Date.now() - this.startTime) / 1000;
                if (elapsed < 300) {
                    this.unlockAchievement('speed_demon');
                }
            }
        };
        
        // Make closeCelebration globally accessible for onclick handler
        window.closeCelebration = function() {
            document.getElementById('celebration').classList.remove('show');
        };
        
        function syncAssessmentToTeam(leadershipType, workRhythm) {
            const teamCode = localStorage.getItem('teamCode') || localStorage.getItem('tap_in_team_code');
            if (!teamCode) return;
            
            // Get or create team members array
            const teamData = JSON.parse(localStorage.getItem('tap_in_team_data') || '{}');
            const members = teamData.members || [];
            
            // Get user info
            const userName = localStorage.getItem('tapin-user-name') || localStorage.getItem('userName') || 'You';
            const userCode = localStorage.getItem('tap_in_user_code') || 'user_' + Date.now();
            
            // Find or create user in team
            let memberIndex = members.findIndex(m => 
                m.userCode === userCode || 
                (userName && m.name && m.name.toLowerCase() === userName.toLowerCase())
            );
            
            const memberData = {
                name: userName,
                userCode: userCode,
                leadershipType: leadershipType,
                leadershipStyle: leadershipType,
                workRhythm: workRhythm,
                workerType: workRhythm,
                belt: localStorage.getItem('currentBelt') || 'white',
                stripe: parseInt(localStorage.getItem('currentStripe')) || 1,
                xp: parseInt(localStorage.getItem('totalXP')) || 0,
                lastActive: new Date().toISOString(),
                assessmentCompleted: true
            };
            
            if (memberIndex >= 0) {
                members[memberIndex] = { ...members[memberIndex], ...memberData };
            } else {
                memberData.joinedDate = new Date().toISOString();
                members.push(memberData);
            }
            
            // Save team data
            teamData.members = members;
            localStorage.setItem('tap_in_team_data', JSON.stringify(teamData));
            localStorage.setItem('teamMembers', JSON.stringify(members));
        }
        
        // Initialize gamification
        GAMIFICATION.load();
        GAMIFICATION.unlockAchievement('first_start');
        
        let executiveMode = false;
        let executiveQuestions = [];
        
        // Make toggleExecutiveMode globally accessible for onchange handler
        window.toggleExecutiveMode = function() {
            executiveMode = document.getElementById('executiveMode').checked;
            const questionCount = document.getElementById('questionCount');
            const timeEstimate = document.getElementById('timeEstimate');
            
            if (executiveMode) {
                questionCount.textContent = '20';
                timeEstimate.textContent = '7';
                // Add executive questions to the array
                if (executiveQuestions.length === 0) {
                    executiveQuestions = [
                        {
                            category: "Strategische Führung",
                            text: "Bei Präsentationen vor dem Vorstand oder Investoren liegt Dein Hauptfokus auf...",
                            options: [
                                { text: "Eine überzeugende Vision zukünftiger Möglichkeiten und Marktchancen zu präsentieren", type: "visionary" },
                                { text: "Detaillierte Daten, Prognosen und systematische Analysen vorzustellen", type: "architect" },
                                { text: "Vertrauen aufzubauen und zu zeigen, wie das Team ausgerichtet und unterstützt wird", type: "facilitator" },
                                { text: "Konkrete Ergebnisse, erreichte Meilensteine und einen klaren Ausführungsplan zu zeigen", type: "executor" }
                            ],
                            insight: {
                                title: "Kommunikationsstile im Vorstand",
                                content: "Effektive Vorstandspräsentationen erfordern Anpassung an Dein Publikum. Visionsorientiert funktioniert für Wachstumsunternehmen, datengetrieben für etablierte Organisationen, vertrauensbildend für beziehungsorientierte Vorstände und ergebnisorientiert für leistungsorientierte Investoren."
                            }
                        },
                        {
                            category: "Strategische Führung",
                            text: "Während einer Unternehmenskrise (z.B. größerer Produktfehler, PR-Problem, Marktveränderung) ...",
                            options: [
                                { text: "Interpretierst Du die Krise als Chance und mobilisierst das Team für eine neue Vision", type: "visionary" },
                                { text: "Analysierst Du die Grundursachen systematisch und erstellst einen strukturierten Wiederherstellungsplan", type: "architect" },
                                { text: "Fokussierst Du Dich auf Team-Moral, sicherst psychologische Sicherheit und pflegst Beziehungen", type: "facilitator" },
                                { text: "Ergreifst Du sofortige entscheidende Maßnahmen, schneidest Verluste ab und pivotierst schnell", type: "executor" }
                            ],
                            insight: {
                                title: "Krisen-Führungsmuster",
                                content: "Forschung zeigt, dass erfolgreiche Krisenführer mehrere Ansätze kombinieren: sofortiges Handeln (Executor), systematische Analyse (Architect), Team-Unterstützung (Facilitator) und Zukunftsvision (Visionary). Die besten Führungskräfte wechseln flexibel zwischen den Stilen."
                            }
                        },
                        {
                            category: "Strategische Führung",
                            text: "Beim Festlegen unternehmensweiter OKRs (Objectives and Key Results) priorisierst Du...",
                            options: [
                                { text: "Mutige, ehrgeizige Ziele, die die Organisation inspirieren und fordern", type: "visionary" },
                                { text: "Gut strukturierte, messbare Ergebnisse mit klaren Metriken und Abhängigkeiten", type: "architect" },
                                { text: "Inklusives Zielsetzung, das Zustimmung und Team-Ausrichtung sicherstellt", type: "facilitator" },
                                { text: "Erreichbare Ziele mit Fokus auf greifbare, kurzfristige Ergebnisse", type: "executor" }
                            ],
                            insight: {
                                title: "Strategische Zielsetzungsansätze",
                                content: "Unterschiedliche OKR-Ansätze schaffen unterschiedliche Organisationsdynamiken. Ehrgeizige Ziele treiben Innovation an, riskieren aber Burnout. Strukturierte Metriken schaffen Klarheit, könnten aber Kreativität einschränken. Inklusive Prozesse bauen Engagement auf, verlangsamen aber Entscheidungsfindung. Kurzfristiger Fokus liefert Ergebnisse, opfert aber möglicherweise langfristige Positionierung."
                            }
                        },
                        {
                            category: "Strategische Führung",
                            text: "Wenn eine wichtige Führungskraft nicht gut genug performt, ist Dein Ansatz...",
                            options: [
                                { text: "Ein Bild ihres Potenzials zu zeichnen und sie zu Wachstum zu inspirieren", type: "visionary" },
                                { text: "Einen strukturierten Entwicklungsplan mit klaren Meilensteinen und Unterstützung zu erstellen", type: "architect" },
                                { text: "Tiefgehende Coaching-Gespräche zu führen, um Grundursachen zu verstehen und anzugehen", type: "facilitator" },
                                { text: "Klare Erwartungen und Zeitpläne zu setzen, mit Konsequenzen wenn nicht erfüllt", type: "executor" }
                            ],
                            insight: {
                                title: "Executive Performance Management",
                                content: "Forschung zum Executive Coaching zeigt, dass die Kombination von Ansätzen am besten funktioniert: klare Erwartungen (Executor), strukturierte Unterstützung (Architect), tiefes Verständnis (Facilitator) und inspirierendes Potenzial (Visionary). Zeitkritische Situationen erfordern jedoch möglicherweise die Priorisierung bestimmter Ansätze."
                            }
                        },
                        {
                            category: "Strategische Führung",
                            text: "Bei der Entscheidung zwischen zwei strategischen Richtungen mit starken Befürwortern auf jeder Seite...",
                            options: [
                                { text: "Formulierst Du einen dritten Weg, der das Beste aus beiden Visionen kombiniert", type: "visionary" },
                                { text: "Führst Du eine strukturierte Analyse durch, die Daten, Risiken und ROI jeder Option vergleicht", type: "architect" },
                                { text: "Moderierst Du eine Team-Diskussion, um Konsens und gemeinsames Verständnis aufzubauen", type: "facilitator" },
                                { text: "Triffst Du eine klare Entscheidung basierend auf Deinem Urteil und gehst entschlossen voran", type: "executor" }
                            ],
                            insight: {
                                title: "Strategische Entscheidungsfindung unter Konflikt",
                                content: "Forschung zu strategischen Entscheidungen zeigt, dass erfolgreiche Führungskräfte je nach Dringlichkeit und Bedeutung unterschiedliche Ansätze verwenden. Hochdringliche Entscheidungen profitieren von entschlossenem Handeln. Komplexe Abwägungen profitieren von systematischer Analyse. Kultursensible Situationen profitieren von inklusiven Prozessen. Langfristige strategische Wetten profitieren von visionärer Synthese."
                            }
                        }
                    ];
                }
            } else {
                questionCount.textContent = '15';
                timeEstimate.textContent = '5';
                
                // If disabling executive mode and we're past regular questions, move back
                if (currentQuestion >= questions.length) {
                    currentQuestion = questions.length - 1;
                }
            }
            
            // Re-render current question with updated progress (no reset!)
            renderQuestion();
        };
        
        const questions = [
            // Leadership Style (Q1-4)
            {
                category: "Leadership Style",
                text: "Wenn Du vor einer wichtigen Entscheidung mit Deinem Team stehst, tust Du typischerweise...",
                options: [
                    { text: "Malst Du eine überzeugende Vision und versammelst Du alle um die Möglichkeiten", type: "visionary" },
                    { text: "Analysierst Du alle verfügbaren Daten und Optionen, bevor Du Dich auf einen Weg festlegst", type: "architect" },
                    { text: "Konsultierst Du zuerst Teammitglieder, um deren Perspektiven zu verstehen", type: "facilitator" },
                    { text: "Triffst Du schnell eine entscheidende Entscheidung und passt Du den Kurs an, wenn Du mehr erfährst", type: "executor" }
                ],
                insight: {
                    title: "Entscheidungsstile",
                    content: "Forschung zeigt, dass effektive Führungskräfte ihren Entscheidungsstil an die Situation anpassen. Visionäre Entscheidungen funktionieren am besten bei strategischen Wendepunkten, datengetriebene bei komplexen Problemen, konsultative für Team-Unterstützung und entscheidende bei dringenden Situationen."
                }
            },
            {
                category: "Leadership Style",
                text: "Dein Team würde sagen, Deine größte Stärke ist...",
                options: [
                    { text: "Dich zu inspirieren, größer zu denken und neue Möglichkeiten zu sehen", type: "visionary" },
                    { text: "Klare Systeme, Prozesse und strukturierte Ansätze zu schaffen", type: "architect" },
                    { text: "Vertrauen, psychologische Sicherheit und starke Beziehungen aufzubauen", type: "facilitator" },
                    { text: "Dinge effizient zu erledigen, ohne Ausreden oder Verzögerungen", type: "executor" }
                ],
                insight: {
                    title: "Wahrgenommene Stärken",
                    content: "Forschung zeigt, dass Führungskräfte, die sich ihrer wahrgenommenen Stärken bewusst sind, 40% effektiver sind. Teams schätzen verschiedene Stärken: Visionäre inspirieren Innovation, Architekten schaffen Stabilität, Facilitatoren bauen Kultur auf und Executoren liefern Ergebnisse."
                }
            },
            {
                category: "Leadership Style",
                text: "In Teambesprechungen wirst Du am ehesten...",
                options: [
                    { text: "Die Gruppe herausfordern, über zukünftige Möglichkeiten und Innovationen nachzudenken", type: "visionary" },
                    { text: "Klärende Fragen stellen und sicherstellen, dass wir strukturierte Notizen und nächste Schritte haben", type: "architect" },
                    { text: "Sicherstellen, dass die Stimme jedes Einzelnen gehört wird und sich die Menschen einbezogen fühlen", type: "facilitator" },
                    { text: "Auf klare Aktionspunkte, Fristen und verantwortliche Eigentümer drängen", type: "executor" }
                ],
                insight: {
                    title: "Meeting-Führungsstile",
                    content: "Effektive Meetings benötigen alle vier Ansätze: Vision (großes Bild), Struktur (Organisation), Einbeziehung (Teilnahme) und Aktion (Verantwortlichkeit). Die besten Führungskräfte wechseln zwischen diesen basierend auf dem Meeting-Zweck."
                }
            },
            {
                category: "Leadership Style",
                text: "Wenn ein Projekt hinter dem Zeitplan zurückbleibt, ist Dein erster Instinkt...",
                options: [
                    { text: "Alle an das größere Bild erinnern und daran, warum diese Arbeit wichtig ist", type: "visionary" },
                    { text: "In die Daten eintauchen, um die Grundursache der Verzögerungen zu finden", type: "architect" },
                    { text: "1:1-Gespräche führen, um zu verstehen, was die Menschen blockiert", type: "facilitator" },
                    { text: "Die Ärmel hochkrempeln und direkt helfen, Hindernisse zu beseitigen", type: "executor" }
                ],
                insight: {
                    title: "Krisenreaktionsmuster",
                    content: "Wenn Projekte ins Rutschen geraten, funktionieren verschiedene Reaktionen für verschiedene Situationen: Vision belebt demotivierte Teams neu, Analyse behebt systemische Probleme, 1:1-Gespräche adressieren individuelle Blockaden und direkte Aktion räumt sofortige Hindernisse aus dem Weg."
                }
            },
            // Work Rhythm (Q5-7)
            {
                category: "Work Rhythm",
                text: "Wie gehen Du am liebsten an herausfordernde Aufgaben heran?",
                options: [
                    { text: "Intensive, fokussierte Phasen mit Pausen zum Aufladen dazwischen", type: "sprinter" },
                    { text: "Stetige, konsistente Anstrengung über den Tag verteilt", type: "jogger" },
                    { text: "Lange, anhaltende Sessions, in denen ich stundenlang tief eintauchen kann", type: "marathoner" }
                ],
                insight: {
                    title: "Arbeitsrhythmus-Muster",
                    content: "Das Verstehen Deines Arbeitsrhythmus ist entscheidend für Spitzenleistung. Sprinter glänzen bei hochintensiven Projekten, Jogger halten stetigen Fortschritt aufrecht und Marathonläufer bewältigen komplexe, langfristige Initiativen. Die besten Teams haben eine Mischung aus allen dreien."
                }
            },
            {
                category: "Work Rhythm",
                text: "Wann sind Du typischerweise geistig am besten?",
                options: [
                    { text: "Frühmorgens - ich bin am schärfsten, bevor andere wach sind", type: "sprinter" },
                    { text: "Mittags - ich komme nach dem Aufwärmen in Schwung", type: "jogger" },
                    { text: "Spätnachmittags/abends - ich baue den ganzen Tag über Schwung auf", type: "marathoner" }
                ]
            },
            {
                category: "Work Rhythm",
                text: "Nach Abschluss eines großen Projekts tun Du typischerweise...",
                options: [
                    { text: "Brauchen eine signifikante Auszeit, bevor Du sich dem nächsten großen Ding widmen", type: "sprinter" },
                    { text: "Machen eine kurze Pause und setzen dann im normalen Tempo fort", type: "jogger" },
                    { text: "Fühlen sich energiegeladen und bereit, die nächste Herausforderung sofort zu beginnen", type: "marathoner" }
                ]
            },
            // Communication (Q8-10)
            {
                category: "Communication",
                text: "Wenn Du eine komplexe Idee erklären, bevorzugen Du...",
                options: [
                    { text: "Mit der großen Vision beginnen und dann Details nach Bedarf hinzufügen", type: "visionary" },
                    { text: "Eine logische, strukturierte Aufschlüsselung mit klaren Schritten präsentieren", type: "architect" },
                    { text: "Geschichten und Beispiele verwenden, die emotional verbinden", type: "facilitator" },
                    { text: "Direkt auf den Punkt kommen mit umsetzbaren Erkenntnissen", type: "executor" }
                ],
                insight: {
                    title: "Kommunikationsstile",
                    content: "Effektive Kommunikation passt sich an das Publikum an. Vision-first funktioniert für strategische Diskussionen, strukturierte Aufschlüsselungen für analytische Teams, Geschichten für den Aufbau von Verbindungen und direkte Aktionspunkte für ausführungsorientierte Kontexte."
                }
            },
            {
                category: "Communication",
                text: "Bei einer Meinungsverschiedenheit mit einem Kollegen werden Du am ehesten...",
                options: [
                    { text: "Sich auf die gemeinsame Vision konzentrieren und gemeinsame Ziele finden", type: "visionary" },
                    { text: "Fakten und Daten präsentieren, um die eigene Position logisch zu untermauern", type: "architect" },
                    { text: "Versuchen, ihre Perspektive zu verstehen, bevor Du die eigene vertreten", type: "facilitator" },
                    { text: "Eine schnelle Entscheidung vorschlagen, um voranzukommen und sie zu testen", type: "executor" }
                ],
                insight: {
                    title: "Konfliktlösungsstile",
                    content: "Forschung zeigt, dass die effektivste Konfliktlösung alle vier kombiniert: Gemeinsamen Nenner finden (Visionär), Daten verwenden (Architekt), Perspektiven verstehen (Facilitator) und vorankommen (Executor). Die besten Führungskräfte verwenden alle vier sequenziell."
                }
            },
            {
                category: "Communication",
                text: "Wenn Du einem Teammitglied Feedback geben, konzentrieren Du sich auf...",
                options: [
                    { text: "Wie ihr Wachstum mit größeren Chancen in der Zukunft zusammenhängt", type: "visionary" },
                    { text: "Spezifische Verhaltensweisen und messbare Verbesserungen, die vorgenommen werden müssen", type: "architect" },
                    { text: "Deine Gefühle und sicherstellen, dass sie sich bei der Verbesserung unterstützt fühlen", type: "facilitator" },
                    { text: "Was sie sofort anders machen müssen", type: "executor" }
                ],
                insight: {
                    title: "Feedback-Effektivität",
                    content: "Das effektivste Feedback umfasst alle vier Elemente: Zukunftsvision (warum es wichtig ist), spezifische Verhaltensweisen (was zu ändern ist), emotionale Unterstützung (wie sie sich fühlen) und sofortige Aktionen (was jetzt zu tun ist). Führungskräfte, die alle vier kombinieren, sehen 60% bessere Verbesserungsraten."
                }
            },
            // Stress & Challenge (Q11-13)
            {
                category: "Under Pressure",
                text: "Wenn Du vor einer wichtigen Frist stehen, tun Du...",
                options: [
                    { text: "Sich von der Herausforderung energetisieren lassen und andere inspirieren, sich zu erheben", type: "visionary" },
                    { text: "Einen detaillierten Plan erstellen und jeden Schritt systematisch ausführen", type: "architect" },
                    { text: "Sich beim Team erkundigen, ob es allen gut geht", type: "facilitator" },
                    { text: "Ablenkungen eliminieren und sich rein auf die Erledigung konzentrieren", type: "executor" }
                ],
                insight: {
                    title: "Leistung unter Druck",
                    content: "Hochdruck-Situationen erfordern alle vier Führungsdimensionen: Energie und Vision (Motivation), systematische Planung (Effizienz), Team-Pflege (Nachhaltigkeit) und fokussierte Ausführung (Ergebnisse). Teams mit Führungskräften, die alle vier ausbalancieren, performen 35% besser unter Druck."
                }
            },
            {
                category: "Under Pressure",
                text: "Deine größte Frustration bei der Arbeit ist normalerweise...",
                options: [
                    { text: "Menschen, die über die heutigen Probleme hinaus keine zukünftigen Möglichkeiten sehen können", type: "visionary" },
                    { text: "Chaos, Mangel an klaren Prozessen und Desorganisation", type: "architect" },
                    { text: "Konflikte, die Beziehungen und Team-Moral schädigen", type: "facilitator" },
                    { text: "Endlose Diskussionen und Meetings ohne konkrete Maßnahmen", type: "executor" }
                ],
                insight: {
                    title: "Frustrationsmuster",
                    content: "Deine Frustrationen offenbaren Deine Werte. Visionäre werden von Kurzsichtigkeit frustriert, Architekten von Chaos, Facilitatoren von Beziehungsschäden und Executoren von Untätigkeit. Das Verstehen dieser Muster hilft Dir zu erkennen, wann Du Deinen Stil flexibel anpassen sollten."
                }
            },
            {
                category: "Under Pressure",
                text: "Wenn Du überfordert sind, bewältigen Du dies, indem Du...",
                options: [
                    { text: "Herauszoomen, um sich wieder mit Sinn und Zweck zu verbinden", type: "visionary" },
                    { text: "Listen erstellen und Aufgaben organisieren, um die Kontrolle zurückzugewinnen", type: "architect" },
                    { text: "Es mit jemandem besprechen, dem Du vertrauen", type: "facilitator" },
                    { text: "Eine Sache auswählen und sie angehen, um Schwung aufzubauen", type: "executor" }
                ],
                insight: {
                    title: "Stressmanagement-Strategien",
                    content: "Effektives Stressmanagement verwendet mehrere Strategien: Wiederverbindung mit dem Zweck (Visionär), Struktur schaffen (Architekt), Unterstützung suchen (Facilitator) und Maßnahmen ergreifen (Executor). Führungskräfte, die alle vier Strategien verwenden, erholen sich 50% schneller von Überforderung."
                }
            },
            // Energy & Motivation (Q14-15)
            {
                category: "Motivation",
                text: "Du fühlen sich am energiegeladensten, wenn...",
                options: [
                    { text: "Neue Ideen brainstormen und sich vorstellen, was möglich sein könnte", type: "visionary" },
                    { text: "Komplexe Probleme mit eleganten, systematischen Lösungen lösen", type: "architect" },
                    { text: "Jemandem helfen, einen Durchbruch zu erzielen oder neue Fähigkeiten zu entwickeln", type: "facilitator" },
                    { text: "Wichtige Punkte von der Liste streichen und greifbaren Fortschritt sehen", type: "executor" }
                ],
                insight: {
                    title: "Energiequellen",
                    content: "Das Verstehen, was Du energetisiert, hilft Dir, Deinen Tag für Spitzenleistung zu strukturieren. Visionäre brauchen kreative Zeit, Architekten brauchen Problemlösungs-Herausforderungen, Facilitatoren brauchen Menschen-Interaktionen und Executoren brauchen klare Erfolge und Fortschritt."
                }
            },
            {
                category: "Motivation",
                text: "Was treibt Du am meisten in Ihrer Führungsrolle an?",
                options: [
                    { text: "Etwas Sinnvolles schaffen, das mich überdauert", type: "visionary" },
                    { text: "Systeme aufbauen, die effizient funktionieren und skalieren", type: "architect" },
                    { text: "Menschen entwickeln und ihnen beim Wachsen zusehen", type: "facilitator" },
                    { text: "Ergebnisse erzielen und ehrgeizige Ziele erreichen", type: "executor" }
                ],
                insight: {
                    title: "Kernmotivation",
                    content: "Your core motivation drives your leadership effectiveness. Visionaries create legacy, Architects build systems, Facilitators develop people, and Executors deliver results. The most successful leaders find ways to satisfy all four motivations over time."
                }
            }
        ];

        const typeData = {
            visionary: { 
                name: "Visionary Leader", 
                desc: "You inspire with bold vision and help others see possibilities they couldn't imagine alone. Your gift is connecting today's work to tomorrow's impact." 
            },
            architect: { 
                name: "Strategic Architect", 
                desc: "You build systems that scale and bring clarity to complexity through structured thinking. Your gift is turning chaos into elegant, repeatable solutions." 
            },
            facilitator: { 
                name: "Catalyst Coach", 
                desc: "You unlock team potential by creating safety and ensuring every voice matters. Your gift is bringing out the best in people through genuine connection." 
            },
            executor: { 
                name: "Momentum Driver", 
                desc: "You turn plans into reality with relentless focus on results and forward motion. Your gift is cutting through noise to make things happen." 
            }
        };

        const rhythmData = {
            sprinter: "Sprinter",
            jogger: "Steady Performer", 
            marathoner: "Endurance Player"
        };

        let currentQuestion = 0;
        let answers = {};
        let scores = { visionary: 0, architect: 0, facilitator: 0, executor: 0 };
        let rhythmScores = { sprinter: 0, jogger: 0, marathoner: 0 };

        function getCurrentQuestions() {
            return executiveMode ? [...questions, ...executiveQuestions] : questions;
        }
        
        // Make selectOption globally accessible IMMEDIATELY (before renderQuestion)
        // This ensures onclick handlers can access it
        window.selectOption = function(index, type) {
            console.log('selectOption called:', index, type, 'currentQuestion:', currentQuestion);
            
            const allQuestions = getCurrentQuestions();
            if (!allQuestions || currentQuestion >= allQuestions.length) {
                console.error('Invalid question index:', currentQuestion);
                return;
            }
            
            const q = allQuestions[currentQuestion];
            if (!q || !q.options || !q.options[index]) {
                console.error('Invalid option index:', index, 'for question:', currentQuestion);
                return;
            }
            
            // Remove previous score if changing answer
            if (answers[currentQuestion] !== undefined) {
                const prevIndex = answers[currentQuestion];
                if (prevIndex >= 0 && prevIndex < q.options.length) {
                    const prevType = q.options[prevIndex].type;
                    if (['sprinter', 'jogger', 'marathoner'].includes(prevType)) {
                        rhythmScores[prevType]--;
                    } else {
                        scores[prevType]--;
                    }
                }
            }
            
            // Set new answer
            answers[currentQuestion] = index;
            
            // Add new score
            if (['sprinter', 'jogger', 'marathoner'].includes(type)) {
                rhythmScores[type]++;
            } else {
                scores[type]++;
            }
            
            // Save progress after each answer
            saveProgress();
            
            // Update UI to show selected state
            renderQuestion();
        };
        
        // Save progress to localStorage
        function saveProgress() {
            try {
                const progress = {
                    currentQuestion: currentQuestion,
                    answers: answers,
                    scores: scores,
                    rhythmScores: rhythmScores,
                    executiveMode: executiveMode,
                    timestamp: new Date().toISOString()
                };
                if (typeof safeSet === 'function') {
                    safeSet('assessmentProgress', progress);
                } else {
                    localStorage.setItem('assessmentProgress', JSON.stringify(progress));
                }
            } catch (error) {
                console.error('Error saving progress:', error);
                if (typeof TapInErrorHandler !== 'undefined') {
                    TapInErrorHandler.logError('saveProgress', error);
                }
            }
        }
        
        // Load progress from localStorage
        function loadProgress() {
            try {
                let saved;
                if (typeof safeGet === 'function') {
                    saved = safeGet('assessmentProgress');
                } else {
                    const savedStr = localStorage.getItem('assessmentProgress');
                    saved = savedStr ? JSON.parse(savedStr) : null;
                }
                
                if (saved && saved.answers) {
                    currentQuestion = saved.currentQuestion || 0;
                    answers = saved.answers || {};
                    scores = saved.scores || { visionary: 0, architect: 0, facilitator: 0, executor: 0 };
                    rhythmScores = saved.rhythmScores || { sprinter: 0, jogger: 0, marathoner: 0 };
                    executiveMode = saved.executiveMode || false;
                    
                    // Restore executive mode checkbox state
                    const execCheckbox = document.getElementById('executiveMode');
                    if (execCheckbox) {
                        execCheckbox.checked = executiveMode;
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Error loading progress:', error);
                if (typeof TapInErrorHandler !== 'undefined') {
                    TapInErrorHandler.logError('loadProgress', error);
                }
            }
            return false;
        }
        
        function renderQuestion() {
            try {
                const allQuestions = getCurrentQuestions();
                
                // Validate questions array exists and has items
                if (!allQuestions || !Array.isArray(allQuestions) || allQuestions.length === 0) {
                    console.error('No questions available');
                    TapInErrorHandler.showToast('UNKNOWN_ERROR', 'No questions available. Please refresh the page.');
                    return;
                }
                
                // Validate currentQuestion is in bounds
                if (currentQuestion < 0 || currentQuestion >= allQuestions.length) {
                    console.error('Question index out of bounds:', currentQuestion, 'of', allQuestions.length);
                    currentQuestion = 0; // Reset to first question
                }
                
                const q = allQuestions[currentQuestion];
                
                // Validate question object exists
                if (!q || !q.text || !q.options || !Array.isArray(q.options)) {
                    console.error('Invalid question object:', q);
                    TapInErrorHandler.showToast('UNKNOWN_ERROR', 'Question data is invalid. Please refresh the page.');
                    return;
                }
                
                const totalQuestions = allQuestions.length;
                
                // Validate DOM elements exist
                const qNumEl = document.getElementById('qNum');
                const totalQuestionsEl = document.getElementById('totalQuestions');
                const questionCategoryEl = document.getElementById('questionCategory');
                const questionTextEl = document.getElementById('questionText');
                const progressFillEl = document.getElementById('progressFill');
                const progressPercentEl = document.getElementById('progressPercent');
                const container = document.getElementById('optionsContainer');
                
                if (!qNumEl || !totalQuestionsEl || !questionCategoryEl || !questionTextEl || !progressFillEl || !progressPercentEl || !container) {
                    console.error('Required DOM elements not found');
                    TapInErrorHandler.showToast('UNKNOWN_ERROR', 'Page elements not found. Please refresh the page.');
                    return;
                }
                
                // Update question display
                qNumEl.textContent = currentQuestion + 1;
                totalQuestionsEl.textContent = totalQuestions;
                questionCategoryEl.textContent = q.category || 'Leadership';
                questionTextEl.textContent = q.text;
                
                const progress = ((currentQuestion) / totalQuestions * 100);
                progressFillEl.style.width = progress + '%';
                progressPercentEl.textContent = Math.round(progress) + '%';
                
                // Escape function helper for HTML content
                const escapeHtml = (str) => {
                    if (!str) return '';
                    if (typeof TapInSecurity !== 'undefined' && TapInSecurity.escapeHtml) {
                        return TapInSecurity.escapeHtml(str);
                    }
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                };
                
                // Escape function for JavaScript string attributes (prevents breaking onclick)
                const escapeJs = (str) => {
                    if (!str) return '';
                    return String(str)
                        .replace(/\\/g, '\\\\')
                        .replace(/'/g, "\\'")
                        .replace(/"/g, '\\"')
                        .replace(/\n/g, '\\n')
                        .replace(/\r/g, '\\r')
                        .replace(/\t/g, '\\t');
                };
                
                // Build options HTML with inline onclick handlers for reliability
                let html = q.options.map((opt, i) => {
                    if (!opt || !opt.text || !opt.type) {
                        console.warn('Invalid option at index', i, ':', opt);
                        return '';
                    }
                    // Use inline onclick for reliable click handling (matches working assessments)
                    // Escape the type for use in JavaScript string
                    const escapedType = escapeJs(opt.type);
                    return `
                        <div class="option ${answers[currentQuestion] === i ? 'selected' : ''}" 
                             onclick="selectOption(${i}, '${escapedType}')" 
                             role="button" tabindex="0"
                             onkeypress="if(event.key==='Enter'||event.key===' '){selectOption(${i},'${escapedType}');event.preventDefault();}">
                            <div class="option-letter">${String.fromCharCode(65 + i)}</div>
                            <div class="option-text">${escapeHtml(opt.text)}</div>
                        </div>
                    `;
                }).filter(html => html !== '').join('');
                
                // Validate we have options HTML
                if (!html || html.trim() === '') {
                    console.error('No valid options generated for question');
                    TapInErrorHandler.showToast('UNKNOWN_ERROR', 'No options available for this question. Please refresh the page.');
                    return;
                }
                
                // Add educational insight ONLY if answer is selected (after user clicks)
                // This prevents showing insights before user has answered
                if (answers[currentQuestion] !== undefined && q.insight) {
                    html += `
                        <div class="insight-card">
                            <div class="insight-header">
                                <svg aria-hidden="true" class="insight-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
                                </svg>
                                <div class="insight-title">${escapeHtml(q.insight.title || '')}</div>
                            </div>
                            <div class="insight-content">${escapeHtml(q.insight.content || '')}</div>
                        </div>
                    `;
                }
                
                // Use innerHTML directly (we've already escaped the content)
                // Options have inline onclick handlers for reliable click handling
                container.innerHTML = html;
                
                // Update buttons
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                if (prevBtn) prevBtn.disabled = currentQuestion === 0;
                if (nextBtn) {
                    nextBtn.disabled = answers[currentQuestion] === undefined;
                    nextBtn.textContent = currentQuestion === totalQuestions - 1 ? 'Ergebnisse anzeigen' : 'Fortsetzen';
                }
            } catch (error) {
                console.error('Error in renderQuestion:', error);
                TapInErrorHandler.logError('renderQuestion', error);
                TapInErrorHandler.showToast('UNKNOWN_ERROR', 'Failed to load question. Please refresh the page.');
            }
        }


        // Make nextQuestion globally accessible for onclick handler
        window.nextQuestion = function() {
            if (answers[currentQuestion] === undefined) return;
            
            // Award XP for answering
            GAMIFICATION.addXP(GAMIFICATION.xpPerQuestion);
            
            const allQuestions = getCurrentQuestions();
            const halfway = Math.floor(allQuestions.length / 2);
            
            // Check for halfway achievement
            if (currentQuestion + 1 === halfway) {
                GAMIFICATION.unlockAchievement('halfway');
            }
            
            if (currentQuestion < allQuestions.length - 1) {
                currentQuestion++;
                renderQuestion();
            } else {
                showResults();
            }
        };

        // Make prevQuestion globally accessible for onclick handler
        window.prevQuestion = function() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        };

        function showResults() {
            // Validate all questions answered
            const allQuestions = getCurrentQuestions();
            const unanswered = allQuestions.filter((_, i) => answers[i] === undefined);
            if (unanswered.length > 0) {
                TapInErrorHandler.showToast('VALIDATION_ERROR', 
                    `Please answer all questions. ${unanswered.length} remaining.`);
                // Go to first unanswered
                currentQuestion = allQuestions.findIndex((_, i) => answers[i] === undefined);
                renderQuestion();
                return;
            }
            
            // Show loading
            TapInErrorHandler.showLoading('Analyzing your responses...');
            
            // Calculate results (simulate processing time for UX)
            setTimeout(() => {
                try {
                    // Award completion XP and achievements
                    GAMIFICATION.addXP(GAMIFICATION.xpForCompletion);
                    GAMIFICATION.unlockAchievement('complete');
                    GAMIFICATION.checkSpeedDemon();
                    
                    const topType = Object.entries(scores).sort((a, b) => b[1] - a[1])[0][0];
                    const secondType = Object.entries(scores).sort((a, b) => b[1] - a[1])[1][0];
                    const topRhythm = Object.entries(rhythmScores).sort((a, b) => b[1] - a[1])[0][0];
                    const data = typeData[topType];
                    
                    // Store comprehensive results with error handling
                    const results = {
                        leadershipType: topType,
                        secondaryType: secondType,
                        workRhythm: topRhythm,
                        scores: scores,
                        rhythmScores: rhythmScores,
                        timestamp: new Date().toISOString()
                    };
                    
                    const profile = {
                        leadershipType: topType,
                        secondaryType: secondType,
                        workerType: topRhythm,
                        belt: 'white',
                        name: 'Leader',
                        timestamp: new Date().toISOString()
                    };
                    
                    // Save with error handling
                    const saved = safeSet('tap_in_assessment_results', results) && 
                                 safeSet('tap_in_profile', profile);
                    
                    if (!saved) {
                        TapInErrorHandler.hideLoading();
                        TapInErrorHandler.showToast('STORAGE_QUOTA');
                        return;
                    }
                    
                    // Clear progress
                    try {
                        if (typeof safeRemove === 'function') {
                            safeRemove('assessmentProgress');
                        } else {
                            localStorage.removeItem('assessmentProgress');
                        }
                    } catch (error) {
                        console.error('Error clearing progress:', error);
                    }
                    
                    // Sync to team if user is in a team
                    syncAssessmentToTeam(topType, topRhythm);
                    
                    TapInErrorHandler.hideLoading();
                    TapInErrorHandler.showSuccess('Bewertung abgeschlossen!', 'Deine Ergebnisse werden angezeigt...');
                    
                    // Show celebration
                    document.getElementById('totalXP').textContent = GAMIFICATION.xp;
                    document.getElementById('celebration').classList.add('show');
                    
                    setTimeout(() => {
                        document.getElementById('questionContainer').classList.add('hide');
                        document.getElementById('resultsContainer').classList.add('show');
                        document.getElementById('resultType').textContent = data.name;
                        document.getElementById('resultDesc').textContent = data.desc;
                        document.getElementById('progressFill').style.width = '100%';
                        document.getElementById('progressPercent').textContent = '100%';
                    }, 2000);
                    
                } catch (e) {
                    TapInErrorHandler.hideLoading();
                    TapInErrorHandler.logError('showResults', e);
                    TapInErrorHandler.showToast('UNKNOWN_ERROR');
                }
            }, 800);
        }

        // Initialize: render first question
        // Options now use inline onclick handlers, no event delegation needed
        function initializeAssessment() {
            // Try to load saved progress
            const hasProgress = loadProgress();
            
            // Render the first question - options have inline onclick handlers
            renderQuestion();
            console.log('Assessment initialized with inline click handlers' + (hasProgress ? ' (progress restored)' : ''));
        }
        
        // Use DOMContentLoaded to ensure DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAssessment);
        } else {
            // DOM already loaded, but wait a tick to ensure everything is ready
            setTimeout(initializeAssessment, 0);
        }
    </script>
    <script>
        // Unregister old service workers first
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
                // Clear all caches
                if ('caches' in window) {
                    caches.keys().then(function(cacheNames) {
                        return Promise.all(cacheNames.map(function(cacheName) {
                            return caches.delete(cacheName);
                        }));
                    }).then(function() {
                        // Register new minimal service worker
                        navigator.serviceWorker.register('../../sw.js', { scope: '/' })
                            .catch(() => {});
                    });
                } else {
                    navigator.serviceWorker.register('../../sw.js', { scope: '/' })
                        .catch(() => {});
                }
            });
        }
    </script>
</body>
</html>
