<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Performance: Resource Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <!-- Performance: Resource Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <title>üì§ Data Manager - TAP-IN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #a93226 0%, #7a2419 100%);
            border-radius: 15px;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .section h2 {
            color: #a93226;
            margin-bottom: 20px;
        }
        .btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #a93226 0%, #7a2419 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            margin: 10px 10px 10px 0;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(169, 50, 38, 0.4);
        }
        .btn.secondary {
            background: linear-gradient(135deg, #555 0%, #333 100%);
        }
        .btn.danger {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        .btn.success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #a93226;
            margin: 10px 0;
        }
        .stat-label {
            opacity: 0.8;
        }
        .file-input {
            display: none;
        }
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #a93226;
            background: rgba(169, 50, 38, 0.1);
        }
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        .message.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
        }
        .message.error {
            background: rgba(220, 38, 38, 0.2);
            border: 1px solid #dc2626;
        }
        .checkbox-group {
            margin: 20px 0;
        }
        .checkbox-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
        }
        input[type="checkbox"] {
            margin-right: 10px;
        }
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: white;
            text-decoration: none;
            opacity: 0.8;
        }
        .data-preview {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            margin: 15px 0;
        }
    </style>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#c62828">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TAP-IN">
    <link rel="stylesheet" href="css/pwa-install-banner.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì§ Data Manager</h1>
            <p>Export, import, and manage your TAP-IN data</p>
        </div>

        <div id="successMessage" class="message success"></div>
        <div id="errorMessage" class="message error"></div>

        <!-- Data Overview -->
        <div class="section">
            <h2>üìä Your Data Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Assessments</div>
                    <div class="stat-value" id="assessmentCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Team Memberships</div>
                    <div class="stat-value" id="teamCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Candidates</div>
                    <div class="stat-value" id="candidateCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Storage</div>
                    <div class="stat-value" id="storageSize">0 KB</div>
                </div>
            </div>
        </div>

        <!-- Export Data -->
        <div class="section">
            <h2>üì• Export Data</h2>
            <p style="opacity: 0.8; margin-bottom: 20px;">Download your data as JSON for backup or transfer to another device</p>
            
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <label>
                        <input type="checkbox" id="exportAssessments" checked>
                        <strong>Assessment Results</strong> - All your completed assessments
                    </label>
                </div>
                <div class="checkbox-item">
                    <label>
                        <input type="checkbox" id="exportTeams" checked>
                        <strong>Team Data</strong> - Team memberships and settings
                    </label>
                </div>
                <div class="checkbox-item">
                    <label>
                        <input type="checkbox" id="exportCandidates" checked>
                        <strong>Recruiter Data</strong> - Candidate information
                    </label>
                </div>
                <div class="checkbox-item">
                    <label>
                        <input type="checkbox" id="exportBadges" checked>
                        <strong>Achievements</strong> - Unlocked badges and progress
                    </label>
                </div>
                <div class="checkbox-item">
                    <label>
                        <input type="checkbox" id="exportSettings" checked>
                        <strong>Settings</strong> - Preferences and customizations
                    </label>
                </div>
            </div>

            <button class="btn success" onclick="exportData()">üì• Download Backup (JSON)</button>
            <button class="btn secondary" onclick="exportCSV()">üìä Download as CSV</button>
        </div>

        <!-- Import Data -->
        <div class="section">
            <h2>üì§ Import Data</h2>
            <p style="opacity: 0.8; margin-bottom: 20px;">Restore data from a previous backup or transfer from another device</p>
            
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3em; margin-bottom: 10px;">üìÅ</div>
                <div style="font-size: 1.2em; margin-bottom: 10px;">Click to select backup file</div>
                <div style="opacity: 0.7; font-size: 0.9em;">Supports JSON files exported from TAP-IN</div>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".json" onchange="handleFileUpload(event)">

            <div style="margin-top: 20px;">
                <label>
                    <input type="checkbox" id="mergeData" checked>
                    <strong>Merge with existing data</strong> (uncheck to replace all data)
                </label>
            </div>
        </div>

        <!-- Clear Data -->
        <div class="section">
            <h2>üóëÔ∏è Clear Data</h2>
            <p style="opacity: 0.8; margin-bottom: 20px;">‚ö†Ô∏è Warning: These actions cannot be undone. Export a backup first!</p>
            
            <button class="btn danger" onclick="clearAssessments()">Clear Assessments Only</button>
            <button class="btn danger" onclick="clearTeams()">Clear Team Data</button>
            <button class="btn danger" onclick="clearCandidates()">Clear Recruiter Data</button>
            <button class="btn danger" onclick="clearAllData()">Clear Everything</button>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="/dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <script>
        // Update overview on load
        function updateOverview() {
            const assessments = JSON.parse(localStorage.getItem('tap-in-assessments') || '[]');
            const teams = JSON.parse(localStorage.getItem('tap-in-teams') || '[]');
            const candidates = JSON.parse(localStorage.getItem('recruiter-candidates') || '[]');
            
            document.getElementById('assessmentCount').textContent = assessments.length;
            document.getElementById('teamCount').textContent = teams.length;
            document.getElementById('candidateCount').textContent = candidates.length;
            
            // Calculate storage size
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.startsWith('tap-in') || key.startsWith('recruiter')) {
                    totalSize += localStorage[key].length * 2; // 2 bytes per character
                }
            }
            document.getElementById('storageSize').textContent = (totalSize / 1024).toFixed(1) + ' KB';
        }

        function showMessage(type, text) {
            const messageEl = document.getElementById(type + 'Message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        function exportData() {
            const data = {};
            
            if (document.getElementById('exportAssessments').checked) {
                data.assessments = JSON.parse(localStorage.getItem('tap-in-assessments') || '[]');
            }
            if (document.getElementById('exportTeams').checked) {
                data.teams = JSON.parse(localStorage.getItem('tap-in-teams') || '[]');
                data.currentTeam = localStorage.getItem('tap-in-current-team');
            }
            if (document.getElementById('exportCandidates').checked) {
                data.candidates = JSON.parse(localStorage.getItem('recruiter-candidates') || '[]');
            }
            if (document.getElementById('exportBadges').checked) {
                data.badges = JSON.parse(localStorage.getItem('tap-in-badges') || '[]');
                data.shared = localStorage.getItem('tap-in-shared');
            }
            if (document.getElementById('exportSettings').checked) {
                data.settings = {
                    theme: localStorage.getItem('tap-in-theme'),
                    customLogo: localStorage.getItem('tap-in-custom-logo'),
                    brandingColors: localStorage.getItem('tap-in-branding-colors')
                };
            }

            data.exportDate = new Date().toISOString();
            data.version = '1.0';

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tap-in-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('success', '‚úÖ Backup downloaded successfully!');
        }

        function exportCSV() {
            const assessments = JSON.parse(localStorage.getItem('tap-in-assessments') || '[]');
            
            if (assessments.length === 0) {
                showMessage('error', '‚ùå No assessments to export');
                return;
            }

            let csv = 'Date,Type,Total Score,Worker Type,Leadership Style,Categories\n';
            
            assessments.forEach(assessment => {
                const date = new Date(assessment.timestamp).toLocaleDateString();
                const type = assessment.type || 'Unknown';
                const score = assessment.totalScore || 0;
                const workerType = assessment.workerType || '';
                const leadershipStyle = assessment.leadershipStyle || '';
                const categories = assessment.scores ? Object.entries(assessment.scores).map(([k, v]) => `${k}:${v}`).join(';') : '';
                
                csv += `"${date}","${type}",${score},"${workerType}","${leadershipStyle}","${categories}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tap-in-assessments-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('success', '‚úÖ CSV exported successfully!');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const mergeMode = document.getElementById('mergeData').checked;

                    if (!mergeMode) {
                        // Clear existing data first
                        if (data.assessments) localStorage.removeItem('tap-in-assessments');
                        if (data.teams) {
                            localStorage.removeItem('tap-in-teams');
                            localStorage.removeItem('tap-in-current-team');
                        }
                        if (data.candidates) localStorage.removeItem('recruiter-candidates');
                        if (data.badges) {
                            localStorage.removeItem('tap-in-badges');
                            localStorage.removeItem('tap-in-shared');
                        }
                    }

                    // Import data
                    if (data.assessments) {
                        const existing = mergeMode ? JSON.parse(localStorage.getItem('tap-in-assessments') || '[]') : [];
                        const merged = [...existing, ...data.assessments];
                        localStorage.setItem('tap-in-assessments', JSON.stringify(merged));
                    }

                    if (data.teams) {
                        const existing = mergeMode ? JSON.parse(localStorage.getItem('tap-in-teams') || '[]') : [];
                        const merged = [...existing, ...data.teams];
                        localStorage.setItem('tap-in-teams', JSON.stringify(merged));
                        if (data.currentTeam) localStorage.setItem('tap-in-current-team', data.currentTeam);
                    }

                    if (data.candidates) {
                        const existing = mergeMode ? JSON.parse(localStorage.getItem('recruiter-candidates') || '[]') : [];
                        const merged = [...existing, ...data.candidates];
                        localStorage.setItem('recruiter-candidates', JSON.stringify(merged));
                    }

                    if (data.badges) {
                        const existing = mergeMode ? JSON.parse(localStorage.getItem('tap-in-badges') || '[]') : [];
                        const merged = [...new Set([...existing, ...data.badges])];
                        localStorage.setItem('tap-in-badges', JSON.stringify(merged));
                        if (data.shared) localStorage.setItem('tap-in-shared', data.shared);
                    }

                    if (data.settings) {
                        if (data.settings.theme) localStorage.setItem('tap-in-theme', data.settings.theme);
                        if (data.settings.customLogo) localStorage.setItem('tap-in-custom-logo', data.settings.customLogo);
                        if (data.settings.brandingColors) localStorage.setItem('tap-in-branding-colors', data.settings.brandingColors);
                    }

                    showMessage('success', `‚úÖ Data imported successfully! (${mergeMode ? 'Merged' : 'Replaced'})`);
                    updateOverview();
                } catch (error) {
                    showMessage('error', '‚ùå Invalid file format. Please upload a valid TAP-IN backup file.');
                }
            };
            reader.readAsText(file);
        }

        function clearAssessments() {
            if (confirm('Are you sure you want to delete all assessments? This cannot be undone!')) {
                localStorage.removeItem('tap-in-assessments');
                showMessage('success', '‚úÖ Assessments cleared');
                updateOverview();
            }
        }

        function clearTeams() {
            if (confirm('Are you sure you want to delete all team data? This cannot be undone!')) {
                localStorage.removeItem('tap-in-teams');
                localStorage.removeItem('tap-in-current-team');
                showMessage('success', '‚úÖ Team data cleared');
                updateOverview();
            }
        }

        function clearCandidates() {
            if (confirm('Are you sure you want to delete all recruiter data? This cannot be undone!')) {
                localStorage.removeItem('recruiter-candidates');
                showMessage('success', '‚úÖ Recruiter data cleared');
                updateOverview();
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL your TAP-IN data including assessments, teams, badges, and settings. Are you absolutely sure?')) {
                if (confirm('Last chance! This action cannot be undone. Click OK to permanently delete everything.')) {
                    for (let key in localStorage) {
                        if (key.startsWith('tap-in') || key.startsWith('recruiter')) {
                            localStorage.removeItem(key);
                        }
                    }
                    showMessage('success', '‚úÖ All data cleared');
                    updateOverview();
                }
            }
        }

        // Initialize
        updateOverview();
    </script>

    <!-- Performance Optimizer - Load First -->
<script src="js/performance-optimizer.min.js"></script>
<!-- TAP-IN Utilities -->
<script src="js/shared-utilities.js"></script>
<script src="js/global-error-handler.min.js"></script>
<script src="js/storage-health.min.js"></script>
    <!-- TAP-IN Core Modules -->
    <script src="js/language-switcher.min.js"></script>
    <script src="js/meta-tags-manager.js"></script>
    <script src="js/achievement-badges.js"></script>
    <script src="js/structured-data.js"></script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('New service worker available');
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        // Silent fail - not critical
                    });
            });
        }
    </script>
    <script src="js/pwa-install-prompt.js"></script>

    <!-- Screen Reader Enhancements for Accessibility -->
    <script src="js/screen-reader-enhancements.js" defer></script>
</body>
</html>
