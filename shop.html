<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Performance: Resource Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <!-- Performance: Resource Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <title>TAP-IN Shop | Avatar Items & Streak Extensions</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/core-styles.css">
    <link rel="stylesheet" href="avatar-styles.css">
    
    <!-- Coins & Avatar Systems -->
    <script src="js/coins-system.min.js" defer></script>
    <script src="js/enhanced-avatar-system.min.js" defer></script>
    <script src="js/avatar-system.min.js" defer></script>
    <script src="js/language-switcher.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js" defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-navy: #1a365d;
            --navy-light: #2d4a7c;
            --accent-gold: #f6e05e;
            --success-green: #38a169;
            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --text-white: #ffffff;
            --text-muted: #a0aec0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1d2e 100%);
            color: var(--text-white);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-gold), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .coins-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(246, 224, 94, 0.1);
            padding: 1rem 2rem;
            border-radius: 50px;
            border: 2px solid var(--accent-gold);
            margin-top: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Navigation */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .nav-links a {
            color: var(--text-white);
            text-decoration: none;
            margin: 0 1rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--bg-card);
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-white);
        }

        .tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        /* Shop Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .shop-item {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .shop-item:hover {
            border-color: var(--accent-gold);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(246, 224, 94, 0.2);
        }

        .shop-item.owned {
            opacity: 0.6;
        }

        .shop-item.owned::after {
            content: '‚úì OWNED';
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--success-green);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .item-icon {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 1rem;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .item-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            min-height: 60px;
        }

        .item-price {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
        }

        .price-coins {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .buy-btn {
            background: linear-gradient(135deg, var(--accent-gold), #f59e0b);
            color: #1a1d2e;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .buy-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(246, 224, 94, 0.4);
        }

        .buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .buy-btn.insufficient {
            background: #ef4444;
            color: white;
        }

        /* XP Conversion Section */
        .convert-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid var(--accent-gold);
        }

        .convert-section h2 {
            margin-bottom: 1rem;
            color: var(--accent-gold);
        }

        .convert-input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .convert-input-group input {
            flex: 1;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-white);
            font-size: 1.1rem;
        }

        .convert-btn {
            background: var(--success-green);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Purchase History */
        .history-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 768px) {
            .shop-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <nav>
        <div class="nav-links">
            <a href="gym-dashboard.html">üèãÔ∏è The Gym</a>
            <a href="profile.html">üë§ Profile</a>
        </div>
        <div id="language-switcher"></div>
    </nav>

    <div class="container" id="main-content">
        <header>
            <h1>üõçÔ∏è TAP-IN Shop</h1>
            <div class="coins-display">
                <span>ü™ô</span>
                <span id="coinsBalance">0</span>
                <span>Coins</span>
            </div>
        </header>

        <!-- XP to Coins Conversion -->
        <div class="convert-section">
            <h2>üí± Convert XP to Coins</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                Exchange your XP for coins at a rate of 0.8 (100 XP = 80 Coins)
            </p>
            <div class="convert-input-group">
                <input type="number" id="xpToConvert" placeholder="Enter XP amount (min: 100)" min="100">
                <span style="font-size: 1.2rem; font-weight: 700;">XP</span>
                <span style="font-size: 1.2rem;">‚Üí</span>
                <span id="coinsPreview" style="font-size: 1.2rem; font-weight: 700; color: var(--accent-gold);">0</span>
                <span style="font-size: 1.2rem; font-weight: 700;">Coins</span>
                <button class="convert-btn" onclick="convertXP()">Convert</button>
            </div>
            <div id="convertMessage" style="margin-top: 1rem; font-weight: 600;"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('avatar')">üë§ Avatar Items</button>
            <button class="tab" onclick="switchTab('rewards')">üéÅ Assessment Rewards</button>
            <button class="tab" onclick="switchTab('streak')">üî• Streak Extensions</button>
            <button class="tab" onclick="switchTab('history')">üìú Purchase History</button>
        </div>

        <!-- Avatar Items Tab -->
        <div id="avatarTab" class="tab-content">
            <div class="shop-grid" id="avatarItems"></div>
        </div>

        <!-- Assessment Rewards Tab -->
        <div id="rewardsTab" class="tab-content" style="display: none;">
            <div style="background: var(--bg-card); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 2px solid var(--accent-gold);">
                <h2 style="color: var(--accent-gold); margin-bottom: 1rem;">üéÅ Free Rewards from Your Assessment</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Complete the belt assessment to unlock these exclusive free items!
                </p>
                <a href="belt-assessment-v2.html" style="display: inline-block; background: var(--accent-gold); color: #1a1d2e; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 700;">Take Assessment ‚Üí</a>
            </div>
            <div class="shop-grid" id="assessmentRewards"></div>
        </div>

        <!-- Streak Extensions Tab -->
        <div id="streakTab" class="tab-content" style="display: none;">
            <div class="shop-grid" id="streakItems"></div>
        </div>

        <!-- Purchase History Tab -->
        <div id="historyTab" class="tab-content" style="display: none;">
            <div class="history-section">
                <h2 style="margin-bottom: 1rem;">Your Purchases</h2>
                <div id="purchaseHistory"></div>
            </div>
        </div>
    </div>

    <script>
        // Assessment Rewards (FREE - unlocked by completing assessment or first stripe)
        const assessmentRewards = [
            { 
                id: 'reward-rental-gi', 
                name: 'Rental Gi', 
                description: 'A borrowed gi to start your journey. You\'ll get your own after completing your first stripe!', 
                icon: 'ü•ã', 
                price: 0, 
                type: 'gi', 
                value: '#d1d5db',
                condition: 'white-no-assessment', // Direct white belt path without assessment
                unlocked: false
            },
            { 
                id: 'reward-old-gi', 
                name: 'Old, Used Gi', 
                description: 'Your first training gi - worn, loved, and full of character. Free gift for completing the assessment or your first stripe!', 
                icon: 'ü•ã', 
                price: 0, 
                type: 'gi', 
                value: '#9ca3af',
                condition: 'assessment-or-first-stripe', // Assessment completion OR first stripe
                unlocked: false
            },
            { 
                id: 'reward-flip-flops', 
                name: 'Old Pair of Flip Flops', 
                description: 'Classic dojo footwear - comfortable and authentic. Everyone gets a pair!', 
                icon: 'ü©¥', 
                price: 0, 
                type: 'accessory', 
                value: 'flip-flops',
                condition: 'always', // Everyone gets this
                unlocked: false
            },
            { 
                id: 'reward-wrinkled-belt-white', 
                name: 'Wrinkled, Old White Belt', 
                description: 'Your first belt - wrinkled from training and earned through effort. The beginning of your journey.', 
                icon: 'ü•ã', 
                price: 0, 
                type: 'belt', 
                value: 'white-old',
                condition: 'white', // Default white belt
                unlocked: false
            },
            { 
                id: 'reward-blue-belt-sandbag', 
                name: 'Brand Blue Belt (Sandbag)', 
                description: 'You scored blue belt but should have gotten it long ago. "Sandbagging" means you\'ve been holding back your true potential. This brand new blue belt recognizes the leader you\'ve always been!', 
                icon: 'ü•ã', 
                price: 0, 
                type: 'belt', 
                value: 'blue-new',
                condition: 'blue-sandbag', // Blue belt from assessment but should have been higher
                unlocked: false
            },
            { 
                id: 'reward-purple-belt-coach', 
                name: 'Coach\'s Old Purple Belt', 
                description: 'HIDDEN SUPERSTAR - Extraordinary! Nobody just gets a purple belt like that. This was your coach\'s old belt, passed down to recognize exceptional talent. You didn\'t just pass - you exceeded all expectations.', 
                icon: 'ü•ã', 
                price: 0, 
                type: 'belt', 
                value: 'purple-coach',
                condition: 'purple', // Purple belt from assessment
                unlocked: false
            }
        ];

        // Shop Items Data
        const shopItems = {
            avatar: [
                { id: 'gi-red', name: 'Red Gi', description: 'Stand out with a vibrant red training gi', icon: 'ü•ã', price: 150, type: 'gi', value: '#dc2626' },
                { id: 'gi-gold', name: 'Gold Gi', description: 'Exclusive golden gi for champions', icon: 'ü•ã', price: 200, type: 'gi', value: '#f59e0b' },
                { id: 'gi-black', name: 'Black Gi', description: 'Classic black gi', icon: 'ü•ã', price: 100, type: 'gi', value: '#1f2937' },
                { id: 'hair-1', name: 'Classic Short', description: 'Clean and professional short cut', icon: 'üíá', price: 50, type: 'hair', value: '#3b2e1f', style: 'short' },
                { id: 'hair-2', name: 'Long Waves', description: 'Elegant long wavy hair', icon: 'üíá', price: 75, type: 'hair', value: '#8b4513', style: 'long-wavy' },
                { id: 'hair-3', name: 'Bold Red', description: 'Vibrant red hair that stands out', icon: 'üíá', price: 80, type: 'hair', value: '#dc2626', style: 'bold-red' },
                { id: 'hair-4', name: 'Platinum Blonde', description: 'Stunning platinum blonde locks', icon: 'üíá', price: 90, type: 'hair', value: '#fef3c7', style: 'platinum' },
                { id: 'hair-5', name: 'Jet Black', description: 'Deep black hair for a striking look', icon: 'üíá', price: 60, type: 'hair', value: '#1f2937', style: 'jet-black' },
                { id: 'hair-6', name: 'Purple Streaks', description: 'Cool purple highlights', icon: 'üíá', price: 85, type: 'hair', value: '#8b5cf6', style: 'purple-streaks' },
                { id: 'hair-7', name: 'Curly Afro', description: 'Bold curly afro style', icon: 'üíá', price: 75, type: 'hair', value: '#78350f', style: 'afro' },
                { id: 'hair-8', name: 'Pixie Cut', description: 'Trendy short pixie cut', icon: 'üíá', price: 65, type: 'hair', value: '#6b7280', style: 'pixie' },
                { id: 'hair-9', name: 'Blue Highlights', description: 'Modern blue highlighted hair', icon: 'üíá', price: 95, type: 'hair', value: '#3b82f6', style: 'blue-highlights' },
                { id: 'hair-10', name: 'Pink Ombre', description: 'Stylish pink ombre gradient', icon: 'üíá', price: 100, type: 'hair', value: '#ec4899', style: 'pink-ombre' },
                { id: 'accessory-badge', name: 'Achievement Badge', description: 'Wear your achievements proudly', icon: 'üèÖ', price: 50, type: 'accessory', value: 'badge' },
                { id: 'accessory-patch', name: 'Custom Patch', description: 'Add a custom patch to your gi', icon: '‚≠ê', price: 80, type: 'accessory', value: 'patch' },
                { id: 'accessory-belt-upgrade', name: 'Belt Upgrade Effect', description: 'Special visual effect for belt upgrades', icon: '‚ú®', price: 120, type: 'accessory', value: 'belt-upgrade' }
            ],
            streak: [
                { id: 'streak-1day', name: '1-Day Streak Extension', description: 'Add 1 extra day to your streak', icon: 'üî•', price: 20, days: 1 },
                { id: 'streak-3day', name: '3-Day Streak Extension', description: 'Add 3 extra days to your streak', icon: 'üî•', price: 50, days: 3 },
                { id: 'streak-7day', name: '7-Day Streak Extension', description: 'Add 7 extra days to your streak', icon: 'üî•', price: 100, days: 7 },
                { id: 'streak-freeze', name: 'Streak Freeze', description: 'Prevent losing your streak for one day', icon: '‚ùÑÔ∏è', price: 75, type: 'freeze' }
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCoinsBalance();
            loadShopItems();
            loadPurchaseHistory();
            
            // Check for first stripe completion and auto-claim kit
            autoClaimFirstStripeKit();
            
            // XP conversion input listener
            document.getElementById('xpToConvert').addEventListener('input', updateConversionPreview);
        });

        // Update coins balance display
        function updateCoinsBalance() {
            if (window.CoinsSystem) {
                const coins = CoinsSystem.getCoins();
                document.getElementById('coinsBalance').textContent = coins.toLocaleString();
            }
        }

        // Update conversion preview
        function updateConversionPreview() {
            const xpInput = document.getElementById('xpToConvert');
            const xpAmount = parseInt(xpInput.value) || 0;
            
            if (xpAmount >= 100 && window.CoinsSystem) {
                const coins = CoinsSystem.getConversionPreview(xpAmount);
                document.getElementById('coinsPreview').textContent = coins || 0;
            } else {
                document.getElementById('coinsPreview').textContent = 0;
            }
        }

        // Convert XP to Coins
        function convertXP() {
            const xpInput = document.getElementById('xpToConvert');
            const xpAmount = parseInt(xpInput.value) || 0;
            
            if (!window.CoinsSystem) {
                alert('Coins system not loaded');
                return;
            }
            
            const result = CoinsSystem.convertXPToCoins(xpAmount);
            
            if (result.success) {
                document.getElementById('convertMessage').textContent = 
                    `‚úÖ Converted ${xpAmount} XP to ${result.coinsEarned} coins!`;
                document.getElementById('convertMessage').style.color = '#38a169';
                xpInput.value = '';
                updateCoinsBalance();
                updateConversionPreview();
                
                // Trigger confetti
                if (window.confetti) {
                    confetti({ particleCount: 100, spread: 70 });
                }
            } else {
                document.getElementById('convertMessage').textContent = `‚ùå ${result.error}`;
                document.getElementById('convertMessage').style.color = '#ef4444';
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            event.target.classList.add('active');
        }

        // Load shop items
        function loadShopItems() {
            loadAvatarItems();
            loadStreakItems();
            loadAssessmentRewards();
        }

        // Load assessment rewards
        function loadAssessmentRewards() {
            const container = document.getElementById('assessmentRewards');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Check assessment completion
            const assessmentCompleted = localStorage.getItem('beltAssessmentResult') || 
                                       localStorage.getItem('beltAssessmentDate') ||
                                       localStorage.getItem('tapinBeltAssessment');
            const assessmentBelt = localStorage.getItem('beltAssessmentResult') || 
                                  localStorage.getItem('beltLevel') || 'white';
            
            // Check if direct white belt path (no assessment)
            const hasAssessment = !!assessmentCompleted;
            const firstStripeComplete = localStorage.getItem('whiteBeltStripe1Complete') === 'true';
            
            // Determine sandbag status (blue belt but should have been higher)
            const totalScore = parseInt(localStorage.getItem('assessmentTotal') || '0');
            const isSandbag = assessmentBelt === 'blue' && totalScore >= 60; // Should have been purple
            
            assessmentRewards.forEach(reward => {
                let showReward = false;
                let isUnlocked = false;
                let unlockReason = '';
                
                // Check conditions
                if (reward.condition === 'always') {
                    showReward = true;
                    isUnlocked = assessmentCompleted || firstStripeComplete;
                    if (isUnlocked) unlockReason = 'Unlocked!';
                } else if (reward.condition === 'white-no-assessment') {
                    // Rental Gi: Show for direct white belt path (no assessment) until first stripe
                    showReward = !hasAssessment && assessmentBelt === 'white';
                    if (showReward) {
                        isUnlocked = !firstStripeComplete; // Auto-unlocked until first stripe
                        if (firstStripeComplete) {
                            unlockReason = 'Upgraded! You now have your own Gi.';
                            isUnlocked = true; // Mark as "owned" but show upgrade message
                        } else {
                            unlockReason = 'Currently using - upgrade after first stripe!';
                        }
                    }
                } else if (reward.condition === 'assessment-or-first-stripe') {
                    // Old Used Gi: Available after assessment OR after first stripe
                    showReward = true;
                    // Hide Rental Gi if first stripe is complete (they get upgrade)
                    if (reward.id === 'reward-old-gi' && !hasAssessment && firstStripeComplete) {
                        showReward = true; // Show as upgrade option
                        isUnlocked = firstStripeComplete;
                        unlockReason = 'Unlocked after first stripe!';
                    } else if (reward.id === 'reward-old-gi' && hasAssessment) {
                        isUnlocked = assessmentCompleted;
                        unlockReason = 'Unlocked from assessment!';
                    } else {
                        isUnlocked = assessmentCompleted || firstStripeComplete;
                        if (isUnlocked) unlockReason = 'Unlocked!';
                    }
                } else if (reward.condition === 'white') {
                    showReward = assessmentBelt === 'white';
                    isUnlocked = assessmentCompleted || firstStripeComplete;
                    if (isUnlocked) unlockReason = 'Unlocked!';
                } else if (reward.condition === 'blue-sandbag') {
                    showReward = isSandbag;
                    isUnlocked = isSandbag;
                    if (isUnlocked) unlockReason = 'Hidden Potential Unlocked!';
                } else if (reward.condition === 'purple') {
                    showReward = assessmentBelt === 'purple';
                    isUnlocked = assessmentBelt === 'purple';
                    if (isUnlocked) unlockReason = 'Extraordinary Achievement!';
                }
                
                if (!showReward) return;
                
                const rewardHTML = `
                    <div class="shop-item ${isUnlocked ? 'owned' : ''}" style="border: 2px solid ${isUnlocked ? 'var(--success-green)' : 'var(--accent-gold)'};">
                        <div class="item-icon">${reward.icon}</div>
                        <div class="item-name">${reward.name}</div>
                        <div class="item-description">${reward.description}</div>
                        ${unlockReason ? `<div style="color: var(--accent-gold); font-weight: 600; margin-top: 0.5rem; font-size: 0.9rem;">${unlockReason}</div>` : ''}
                        <div class="item-price">
                            <span class="price-coins" style="color: var(--success-green);">FREE</span>
                            <button class="buy-btn" ${isUnlocked ? 'disabled' : ''} 
                                    onclick="claimReward('${reward.id}')"
                                    style="${isUnlocked ? 'opacity: 0.5; cursor: not-allowed;' : 'background: var(--success-green);'}">
                                ${isUnlocked ? 'Claimed ‚úì' : 'Claim Free'}
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += rewardHTML;
            });
        }

        // Auto-claim first stripe kit (for direct white belt path)
        function autoClaimFirstStripeKit() {
            const firstStripeComplete = localStorage.getItem('whiteBeltStripe1Complete') === 'true';
            const hasAssessment = !!localStorage.getItem('beltAssessmentResult');
            
            // Only for direct white belt path (no assessment) after first stripe
            if (firstStripeComplete && !hasAssessment) {
                const claimed = JSON.parse(localStorage.getItem('assessmentRewardsClaimed') || '[]');
                
                // Auto-claim full kit
                const kitItems = ['reward-old-gi', 'reward-wrinkled-belt-white', 'reward-flip-flops'];
                let newClaims = false;
                
                kitItems.forEach(itemId => {
                    if (!claimed.includes(itemId)) {
                        claimed.push(itemId);
                        const reward = assessmentRewards.find(r => r.id === itemId);
                        if (reward) {
                            applyItem(reward, 'reward');
                            newClaims = true;
                        }
                    }
                });
                
                if (newClaims) {
                    localStorage.setItem('assessmentRewardsClaimed', JSON.stringify(claimed));
                    // Show notification
                    if (window.confetti) {
                        confetti({ particleCount: 150, spread: 70 });
                    }
                    console.log('üéÅ First Stripe Kit auto-claimed!');
                }
            }
        }

        // Claim assessment reward
        function claimReward(rewardId) {
            const reward = assessmentRewards.find(r => r.id === rewardId);
            if (!reward) return;
            
            // Check if already claimed
            const claimed = JSON.parse(localStorage.getItem('assessmentRewardsClaimed') || '[]');
            if (claimed.includes(rewardId)) {
                alert('You already claimed this reward!');
                return;
            }
            
            // Mark as claimed
            claimed.push(rewardId);
            localStorage.setItem('assessmentRewardsClaimed', JSON.stringify(claimed));
            
            // Apply reward
            applyItem(reward, 'reward');
            
            // Check for auto-claim after first stripe
            autoClaimFirstStripeKit();
            
            // Show success
            alert(`‚úÖ ${reward.name} claimed! Check your avatar to see it!`);
            
            // Reload rewards
            loadAssessmentRewards();
            
            // Confetti
            if (window.confetti) {
                confetti({ particleCount: 100, spread: 70 });
            }
        }

        // Check for first stripe completion on load
        window.addEventListener('storage', function(e) {
            if (e.key === 'whiteBeltStripe1Complete') {
                autoClaimFirstStripeKit();
                loadAssessmentRewards();
            }
        });

        // Load avatar items
        function loadAvatarItems() {
            const container = document.getElementById('avatarItems');
            container.innerHTML = '';
            
            shopItems.avatar.forEach(item => {
                const owned = isItemOwned(item.id);
                const canAfford = window.CoinsSystem && window.CoinsSystem.canAfford(item.price);
                
                const itemHTML = `
                    <div class="shop-item ${owned ? 'owned' : ''}">
                        <div class="item-icon">${item.icon}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                        <div class="item-price">
                            <span class="price-coins">${item.price} ü™ô</span>
                            <button class="buy-btn ${owned ? '' : !canAfford ? 'insufficient' : ''}" 
                                    ${owned || !canAfford ? 'disabled' : ''} 
                                    onclick="purchaseItem('${item.id}', 'avatar')">
                                ${owned ? 'Owned' : !canAfford ? 'Need Coins' : 'Buy'}
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
        }

        // Load streak items
        function loadStreakItems() {
            const container = document.getElementById('streakItems');
            container.innerHTML = '';
            
            shopItems.streak.forEach(item => {
                const canAfford = window.CoinsSystem && window.CoinsSystem.canAfford(item.price);
                
                const itemHTML = `
                    <div class="shop-item">
                        <div class="item-icon">${item.icon}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                        <div class="item-price">
                            <span class="price-coins">${item.price} ü™ô</span>
                            <button class="buy-btn ${!canAfford ? 'insufficient' : ''}" 
                                    ${!canAfford ? 'disabled' : ''} 
                                    onclick="purchaseItem('${item.id}', 'streak')">
                                ${!canAfford ? 'Need Coins' : 'Buy'}
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
        }

        // Check if item is owned
        function isItemOwned(itemId) {
            const owned = JSON.parse(localStorage.getItem('shopOwnedItems') || '[]');
            return owned.includes(itemId);
        }

        // Purchase item
        function purchaseItem(itemId, category) {
            if (!window.CoinsSystem) {
                alert('Coins system not loaded');
                return;
            }
            
            // Find item
            const items = category === 'avatar' ? shopItems.avatar : shopItems.streak;
            const item = items.find(i => i.id === itemId);
            
            if (!item) {
                alert('Item not found');
                return;
            }
            
            // Check if owned (for avatar items)
            if (category === 'avatar' && isItemOwned(itemId)) {
                alert('You already own this item!');
                return;
            }
            
            // Check coins
            if (!window.CoinsSystem.canAfford(item.price)) {
                alert('Not enough coins!');
                return;
            }
            
            // Spend coins
            const result = window.CoinsSystem.spendCoins(item.price);
            
            if (result.success) {
                // Add to owned items (avatar)
                if (category === 'avatar') {
                    const owned = JSON.parse(localStorage.getItem('shopOwnedItems') || '[]');
                    owned.push(itemId);
                    localStorage.setItem('shopOwnedItems', JSON.stringify(owned));
                }
                
                // Apply item
                applyItem(item, category);
                
                // Save purchase
                savePurchase(item, category);
                
                // Update UI
                updateCoinsBalance();
                loadShopItems();
                
                // Confetti
                if (window.confetti) {
                    confetti({ particleCount: 100, spread: 70 });
                }
                
                alert(`‚úÖ Purchased ${item.name}!`);
            } else {
                alert('Purchase failed: ' + result.error);
            }
        }

        // Apply item
        function applyItem(item, category) {
            if (category === 'reward') {
                // Handle assessment rewards
                if (item.type === 'gi') {
                    const settings = window.EnhancedAvatarSystem ? window.EnhancedAvatarSystem.getSettings() : {};
                    settings.customGiColor = item.value;
                    if (window.EnhancedAvatarSystem) {
                        window.EnhancedAvatarSystem.saveSettings(settings);
                    }
                    // Save reward as owned
                    const owned = JSON.parse(localStorage.getItem('shopOwnedItems') || '[]');
                    if (!owned.includes(item.id)) {
                        owned.push(item.id);
                        localStorage.setItem('shopOwnedItems', JSON.stringify(owned));
                    }
                } else if (item.type === 'belt') {
                    // Save belt reward
                    localStorage.setItem('assessmentBeltReward', item.value);
                } else if (item.type === 'accessory') {
                    // Add accessory
                    if (window.EnhancedAvatarSystem) {
                        window.EnhancedAvatarSystem.addAccessory(item.value);
                    }
                }
            } else if (category === 'avatar') {
                if (item.type === 'gi') {
                    // Save as custom gi color
                    const settings = window.EnhancedAvatarSystem ? window.EnhancedAvatarSystem.getSettings() : {};
                    settings.customGiColor = item.value;
                    if (window.EnhancedAvatarSystem) {
                        window.EnhancedAvatarSystem.saveSettings(settings);
                    }
                } else if (item.type === 'hair') {
                    // Apply hair color
                    if (window.EnhancedAvatarSystem) {
                        window.EnhancedAvatarSystem.setHairColor(item.value);
                    }
                } else if (item.type === 'accessory') {
                    // Add accessory
                    if (window.EnhancedAvatarSystem) {
                        window.EnhancedAvatarSystem.addAccessory(item.value);
                    }
                }
            } else if (category === 'streak') {
                if (item.type === 'freeze') {
                    // Add streak freeze
                    const freezes = parseInt(localStorage.getItem('streakFreezes') || '0');
                    localStorage.setItem('streakFreezes', (freezes + 1).toString());
                } else if (item.days) {
                    // Extend streak
                    const currentStreak = parseInt(localStorage.getItem('dailyStreak') || '0');
                    localStorage.setItem('dailyStreak', (currentStreak + item.days).toString());
                    if (window.DAILY_STREAK && window.DAILY_STREAK.displayStreak) {
                        window.DAILY_STREAK.displayStreak();
                    }
                }
            }
        }

        // Save purchase to history
        function savePurchase(item, category) {
            const history = JSON.parse(localStorage.getItem('shopPurchaseHistory') || '[]');
            history.unshift({
                id: item.id,
                name: item.name,
                category: category,
                price: item.price,
                timestamp: new Date().toISOString()
            });
            
            // Keep last 50 purchases
            if (history.length > 50) {
                history.pop();
            }
            
            localStorage.setItem('shopPurchaseHistory', JSON.stringify(history));
            loadPurchaseHistory();
        }

        // Load purchase history
        function loadPurchaseHistory() {
            const container = document.getElementById('purchaseHistory');
            const history = JSON.parse(localStorage.getItem('shopPurchaseHistory') || '[]');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No purchases yet. Start shopping!</p>';
                return;
            }
            
            container.innerHTML = '';
            history.forEach(purchase => {
                const date = new Date(purchase.timestamp).toLocaleDateString();
                const historyHTML = `
                    <div class="history-item">
                        <div>
                            <div style="font-weight: 600;">${purchase.name}</div>
                            <div style="color: var(--text-muted); font-size: 0.9rem;">${date}</div>
                        </div>
                        <div style="color: var(--accent-gold); font-weight: 700;">${purchase.price} ü™ô</div>
                    </div>
                `;
                container.innerHTML += historyHTML;
            });
        }
    </script>

    <!-- Screen Reader Enhancements for Accessibility -->
    <script src="js/screen-reader-enhancements.js" defer></script>
</body>
</html>

