!function(){"use strict";const e={syncQueue:[],isSyncing:!1,lastSyncTime:null,syncInterval:null,syncIntervalMs:3e5,listeners:[],init(){this.loadSyncQueue(),this.startBackgroundSync(),window.addEventListener("online",()=>this.handleOnline()),window.addEventListener("offline",()=>this.handleOffline()),window.addEventListener("tapin:auth:signed-in",()=>this.handleAuthSignedIn()),window.addEventListener("tapin:auth:signed-out",()=>this.handleAuthSignedOut()),navigator.onLine&&this.isAuthenticated()&&setTimeout(()=>this.sync(),2e3),console.log("âœ… SyncManager initialized")},isAuthenticated:()=>"undefined"!=typeof TapInSupabase&&TapInSupabase.isInitialized&&null!==TapInSupabase.currentUser,startBackgroundSync(){this.syncInterval&&clearInterval(this.syncInterval),this.syncInterval=setInterval(()=>{navigator.onLine&&this.isAuthenticated()&&this.sync()},this.syncIntervalMs),console.log("ðŸ”„ Background sync started (5 min interval)")},stopBackgroundSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)},queueSync(e){const t={id:"sync_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),operation:e,timestamp:Date.now(),retries:0};return this.syncQueue.push(t),this.saveSyncQueue(),navigator.onLine&&this.isAuthenticated()?setTimeout(()=>this.sync(),500):this.notifyListeners("pending"),t.id},async sync(){if(this.isSyncing)console.log("â³ Sync already in progress");else{if(!navigator.onLine)return console.log("ðŸ“´ Offline - cannot sync"),void this.notifyListeners("offline");if(!this.isAuthenticated())return console.log("ðŸ”’ Not authenticated - cannot sync"),void this.notifyListeners("localOnly");this.isSyncing=!0,this.notifyListeners("syncing");try{await this.syncLocalToServer(),await this.syncServerToLocal(),this.syncQueue=[],this.saveSyncQueue(),this.lastSyncTime=Date.now(),this.notifyListeners("synced"),console.log("âœ… Sync complete")}catch(e){console.error("âŒ Sync error:",e),this.notifyListeners("error",e)}finally{this.isSyncing=!1}}},async syncLocalToServer(){const e=this.collectLocalData();if(0===Object.keys(e).length)return;const t=await TapInSupabase.getUserProfile(TapInSupabase.currentUser.id),n=this.resolveConflicts(e,t);await TapInSupabase.syncToServer(n);for(const e of this.syncQueue)try{await this.processSyncItem(e)}catch(t){console.error("Sync item error:",t),e.retries++}},async syncServerToLocal(){const e=await TapInSupabase.syncFromServer();e&&window.dispatchEvent(new CustomEvent("tapin:sync:completed",{detail:{source:"server",data:e}}))},collectLocalData(){return{totalXP:parseInt(localStorage.getItem("totalXP")||"0"),currentBelt:localStorage.getItem("currentBelt")||"white",currentStripe:parseInt(localStorage.getItem("currentStripe")||"1"),streakCount:parseInt(localStorage.getItem("streakCount")||"0"),progressItems:this.collectProgressItems()}},collectProgressItems(){const e=[];return["white","blue","purple","brown","black"].forEach(t=>{for(let n=1;n<=4;n++){const s=`${t}BeltStripe${n}Complete`;"true"===localStorage.getItem(s)&&e.push({type:"stripe_completion",belt:t,stripe:n,completed_at:localStorage.getItem(`${s}_timestamp`)||(new Date).toISOString()})}}),e},resolveConflicts(e,t){if(!t)return e;const n={...e};if(e.totalXP&&t.total_xp&&(n.totalXP=Math.max(e.totalXP,t.total_xp)),e.streakCount&&t.streak_count&&(n.streakCount=Math.max(e.streakCount,t.streak_count)),t.progressItems&&e.progressItems){const s=[...e.progressItems];t.progressItems.forEach(e=>{s.find(t=>t.belt===e.belt&&t.stripe===e.stripe)||s.push(e)}),n.progressItems=s}return n},async processSyncItem(e){const{operation:t}=e;switch(t.type){case"progress":await TapInSupabase.saveProgress(t.data);break;case"assessment":await TapInSupabase.saveAssessment(t.data);break;case"profile_update":await TapInSupabase.updateUserProfile(t.data);break;default:console.warn("Unknown sync operation type:",t.type)}},async handleOnline(){console.log("ðŸŒ Back online - syncing..."),this.notifyListeners("syncing"),this.isAuthenticated()&&await this.sync()},handleOffline(){console.log("ðŸ“´ Gone offline"),this.notifyListeners("offline")},async handleAuthSignedIn(){console.log("ðŸ”“ User signed in - syncing..."),await this.sync()},handleAuthSignedOut(){console.log("ðŸ”’ User signed out"),this.notifyListeners("localOnly")},loadSyncQueue(){try{const e=localStorage.getItem("tapin_sync_queue");e&&(this.syncQueue=JSON.parse(e))}catch(e){console.error("Load sync queue error:",e),this.syncQueue=[]}},saveSyncQueue(){try{localStorage.setItem("tapin_sync_queue",JSON.stringify(this.syncQueue))}catch(e){console.error("Save sync queue error:",e)}},onStatusChange(e){this.listeners.push(e)},notifyListeners(e,t=null){this.listeners.forEach(n=>{try{n(e,t)}catch(e){console.error("Sync listener error:",e)}})},getStatus(){return navigator.onLine?this.isAuthenticated()?this.isSyncing?"syncing":this.syncQueue.length>0?"pending":this.lastSyncTime?"synced":"localOnly":"localOnly":"offline"}};"undefined"!=typeof window&&(window.SyncManager=e),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{e.init()}):e.init(),"undefined"!=typeof module&&module.exports&&(module.exports=e)}();