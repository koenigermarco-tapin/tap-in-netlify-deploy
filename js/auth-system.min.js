class TapInAuth{constructor(){this.supabase=null,this.currentUser=null,this.backupCode=null,this.init()}async init(){this.supabase=supabase.createClient("YOUR_SUPABASE_URL","YOUR_SUPABASE_ANON_KEY");const{data:{session:e}}=await this.supabase.auth.getSession();if(e)this.currentUser=e.user,await this.loadBackupCode();else{const e=localStorage.getItem("tap_in_backup_code");e?await this.restoreFromBackupCode(e):await this.createAnonymousUser()}this.supabase.auth.onAuthStateChange((e,t)=>{"SIGNED_IN"===e?this.currentUser=t.user:"SIGNED_OUT"===e&&(this.currentUser=null)})}async createAnonymousUser(){try{const{data:e,error:t}=await this.supabase.auth.signInAnonymously();if(t)throw t;return this.currentUser=e.user,this.backupCode=this.generateBackupCode(),await this.saveBackupCode(this.backupCode),localStorage.setItem("tap_in_backup_code",this.backupCode),this.showBackupCodeModal(),{success:!0,userId:e.user.id,backupCode:this.backupCode}}catch(e){return console.error("Error creating anonymous user:",e),{success:!1,error:e}}}generateBackupCode(){const e=["alpha","bravo","charlie","delta","echo","foxtrot","golf","hotel","india","juliet","kilo","lima","mike","november","oscar","papa","quebec","romeo","sierra","tango","uniform","victor","whiskey","xray","yankee","zulu"];return`${e[Math.floor(Math.random()*e.length)]}-${e[Math.floor(Math.random()*e.length)]}-${e[Math.floor(Math.random()*e.length)]}-${Math.floor(1e3+8999*Math.random())}`}async saveBackupCode(e){try{const{error:t}=await this.supabase.from("user_backup_codes").insert({user_id:this.currentUser.id,backup_code:e,created_at:(new Date).toISOString()});if(t)throw t;return!0}catch(e){return console.error("Error saving backup code:",e),!1}}async loadBackupCode(){try{const{data:e,error:t}=await this.supabase.from("user_backup_codes").select("backup_code").eq("user_id",this.currentUser.id).single();if(t)throw t;return this.backupCode=e.backup_code,localStorage.setItem("tap_in_backup_code",this.backupCode),this.backupCode}catch(e){return console.error("Error loading backup code:",e),null}}async restoreFromBackupCode(e){try{const{data:t,error:r}=await this.supabase.from("user_backup_codes").select("user_id").eq("backup_code",e).single();if(r||!t)throw new Error("Invalid backup code");localStorage.setItem("restoring_user_id",t.user_id);const{data:a,error:s}=await this.supabase.auth.signInAnonymously();if(s)throw s;return await this.migrateUserData(t.user_id,a.user.id),await this.supabase.from("user_backup_codes").update({user_id:a.user.id}).eq("backup_code",e),this.currentUser=a.user,this.backupCode=e,localStorage.removeItem("restoring_user_id"),localStorage.setItem("tap_in_backup_code",e),{success:!0,userId:a.user.id}}catch(e){return console.error("Error restoring from backup code:",e),{success:!1,error:e.message}}}async migrateUserData(e,t){try{const{data:r}=await this.supabase.from("avatar_state").select("*").eq("user_id",e).single();r&&await this.supabase.from("avatar_state").insert({...r,user_id:t,id:void 0});const{data:a}=await this.supabase.from("user_progress").select("*").eq("user_id",e);if(a&&a.length>0){const e=a.map(e=>({...e,user_id:t,id:void 0}));await this.supabase.from("user_progress").insert(e)}return await this.supabase.from("avatar_state").delete().eq("user_id",e),await this.supabase.from("user_progress").delete().eq("user_id",e),!0}catch(e){return console.error("Error migrating user data:",e),!1}}async saveProgress(e){if(!this.currentUser)return console.error("No authenticated user"),!1;try{const{error:t}=await this.supabase.from("user_progress").upsert({user_id:this.currentUser.id,current_belt:e.currentBelt,stripes_completed:e.stripesCompleted,total_xp:e.totalXP,completed_lessons:e.completedLessons,last_active:(new Date).toISOString(),updated_at:(new Date).toISOString()},{onConflict:"user_id"});if(t)throw t;return!0}catch(e){return console.error("Error saving progress:",e),!1}}async loadProgress(){if(!this.currentUser)return console.error("No authenticated user"),null;try{const{data:e,error:t}=await this.supabase.from("user_progress").select("*").eq("user_id",this.currentUser.id).single();if(t&&"PGRST116"!==t.code)throw t;return e||null}catch(e){return console.error("Error loading progress:",e),null}}async saveAvatarState(e){if(!this.currentUser)return console.error("No authenticated user"),!1;try{const{error:t}=await this.supabase.from("avatar_state").upsert({user_id:this.currentUser.id,belt:e.belt,belt_stripes:e.beltStripes,gi_color:e.giColor,patch_left:e.patchLeft,patch_right:e.patchRight,background:e.background,owned_items:e.ownedItems,equipped_items:e.equippedItems,active_effects:e.activeEffects,updated_at:(new Date).toISOString()},{onConflict:"user_id"});if(t)throw t;return!0}catch(e){return console.error("Error saving avatar state:",e),!1}}async loadAvatarState(){if(!this.currentUser)return console.error("No authenticated user"),null;try{const{data:e,error:t}=await this.supabase.from("avatar_state").select("*").eq("user_id",this.currentUser.id).single();if(t&&"PGRST116"!==t.code)throw t;return e?{belt:e.belt,beltStripes:e.belt_stripes,giColor:e.gi_color,patchLeft:e.patch_left,patchRight:e.patch_right,background:e.background,ownedItems:e.owned_items,equippedItems:e.equipped_items,activeEffects:e.active_effects}:null}catch(e){return console.error("Error loading avatar state:",e),null}}async getLeaderboard(e=100){try{const{data:t,error:r}=await this.supabase.from("user_progress").select("user_id,total_xp,current_belt,last_active").order("total_xp",{ascending:!1}).limit(e);if(r)throw r;const a=t.map(e=>e.user_id),{data:s}=await this.supabase.from("avatar_state").select("user_id,gi_color,belt,background").in("user_id",a);return t.map((e,t)=>{const r=s?.find(t=>t.user_id===e.user_id);return{rank:t+1,userId:e.user_id,xp:e.total_xp,belt:e.current_belt,avatar:r||null,isCurrentUser:e.user_id===this.currentUser?.id}})}catch(e){return console.error("Error fetching leaderboard:",e),[]}}async getCurrentUserRank(){if(!this.currentUser)return null;try{const{data:e}=await this.supabase.from("user_progress").select("total_xp").eq("user_id",this.currentUser.id).single();if(!e)return null;const{count:t}=await this.supabase.from("user_progress").select("*",{count:"exact",head:!0}).gt("total_xp",e.total_xp);return(t||0)+1}catch(e){return console.error("Error getting user rank:",e),null}}showBackupCodeModal(){const e=document.createElement("div");e.id="backupCodeModal",e.innerHTML=`<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;"><div style="background:white;padding:3rem;border-radius:20px;max-width:500px;text-align:center;"><h2 style="margin-bottom:1rem;color:#1e293b;">üîê Save Your Backup Code</h2><p style="color:#64748b;margin-bottom:2rem;">This code lets you restore your progress on any device. Save it somewhere safe!</p><div style="background:#f8fafc;padding:1.5rem;border-radius:12px;margin-bottom:2rem;font-family:monospace;font-size:1.5rem;font-weight:700;color:#1e293b;word-break:break-all;">${this.backupCode}</div><div style="display:flex;gap:1rem;justify-content:center;margin-bottom:1rem;"><button onclick="TapInAuth.copyBackupCode()" style="padding:1rem 2rem;background:#3b82f6;color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">üìã Copy Code</button><button onclick="TapInAuth.downloadBackupCode()" style="padding:1rem 2rem;background:#10b981;color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">üíæ Download</button></div><button onclick="TapInAuth.closeBackupModal()" style="padding:1rem 2rem;background:#64748b;color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;width:100%;">I've Saved It</button><p style="color:#dc2626;font-size:0.85rem;margin-top:1rem;">‚ö†Ô∏è Without this code,you cannot restore your progress!</p></div></div>`,document.body.appendChild(e)}static copyBackupCode(){const e=window.tapInAuth.backupCode;navigator.clipboard.writeText(e),alert("‚úÖ Backup code copied to clipboard!")}static downloadBackupCode(){const e=window.tapInAuth.backupCode,t=new Blob([`TAP-IN Backup Code\n\n${e}\n\nKeep this code safe!`],{type:"text/plain"}),r=URL.createObjectURL(t),a=document.createElement("a");a.href=r,a.download="tap-in-backup-code.txt",a.click(),URL.revokeObjectURL(r)}static closeBackupModal(){const e=document.getElementById("backupCodeModal");e&&e.remove()}getUserId(){return this.currentUser?.id||null}getBackupCode(){return this.backupCode}isAuthenticated(){return!!this.currentUser}}window.tapInAuth=new TapInAuth,"undefined"!=typeof module&&module.exports&&(module.exports=TapInAuth);