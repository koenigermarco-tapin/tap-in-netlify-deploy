!function(){"use strict";function e(e="User"){const t=localStorage.getItem("userReferralCode");if(t)return t;const r=`${e.toLowerCase().replace(/[^a-z0-9]/g,"").substring(0,10)||"user"}-${Math.random().toString(36).substring(2,6).toUpperCase()}`;return localStorage.setItem("userReferralCode",r),r}function t(){return localStorage.getItem("userReferralCode")||e()}function r(){return new URLSearchParams(window.location.search).get("ref")}function n(){const e=r();if(!e)return null;sessionStorage.setItem("referredBy",e);const n=t(),a=function(e){const t=u(e);if(!t)return[];return[...t.referralLineage||[],e]}(e);a.push(e),a.push(n);const s={userId:l(),referralCode:n,referredBy:e,referralLineage:a,joinedDate:(new Date).toISOString(),personalXP:0,currentBelt:"White"};return o(s),function(e){const t=u(e);if(!t)return;t.studentsCount=(t.studentsCount||0)+1,o(t),function(e){e.forEach(e=>{const t=u(e);t&&(t.lineageCount=(t.lineageCount||0)+1,o(t))})}(t.referralLineage)}(e),s}function o(e){const t=s();t[e.userId]=e,localStorage.setItem("lineageUsers",JSON.stringify(t)),localStorage.setItem("currentUserId",e.userId)}function a(){const e=localStorage.getItem("currentUserId");if(!e){const e=t(),r={userId:l(),referralCode:e,referredBy:null,referralLineage:[],joinedDate:(new Date).toISOString(),personalXP:parseInt(localStorage.getItem("totalXP")||"0"),currentBelt:c()};return o(r),r}return s()[e]||null}function u(e){const t=s();for(const r in t)if(t[r].referralCode===e)return t[r];return null}function s(){const e=localStorage.getItem("lineageUsers");return e?JSON.parse(e):{}}function l(){return"user_"+Date.now()+"_"+Math.random().toString(36).substring(2,9)}function c(){return localStorage.getItem("blackBeltStripe4Complete")?"Black":localStorage.getItem("brownBeltStripe4Complete")?"Brown":localStorage.getItem("purpleBeltStripe4Complete")?"Purple":localStorage.getItem("blueBeltStripe4Complete")?"Blue":"White"}function i(e=null){const t=e?u(e):a();if(!t)return[];const r=s(),n=[];for(const e in r)r[e].referredBy===t.referralCode&&n.push(r[e]);return n.sort((e,t)=>new Date(t.joinedDate)-new Date(e.joinedDate))}function g(e=null){return i(e).reduce((e,t)=>e+(t.personalXP||0),0)}function d(e=null){const t=e?u(e):a();if(!t)return 0;let r=0;const n=i(t.userId);for(const e of n)r+=e.personalXP||0,r+=d(e.userId);return r}function f(e){const t=a();if(t&&(t.personalXP=(t.personalXP||0)+e,t.currentBelt=c(),o(t),t.referredBy)){const e=u(t.referredBy);e&&(e.teamXP=g(e.userId),o(e))}}function m(e=null){const t=e?u(e):a();if(!t)return null;const r=i(t.userId),n=g(t.userId),o=d(t.userId);return{gymName:t.gymName||`${t.referralCode}'s Gym`,gymMotto:t.gymMotto||null,studentsCount:r.length,lineageCount:t.lineageCount||0,teamXP:n,lineageXP:o,personalXP:t.personalXP||0,currentBelt:t.currentBelt||"White",joinedDate:t.joinedDate,students:r}}function I(e="teamXP",t=100){const r=s(),n=[];for(const e in r){const t=r[e],o=m(t.userId);o&&o.studentsCount>0&&n.push({userId:t.userId,gymName:o.gymName,referralCode:t.referralCode,studentsCount:o.studentsCount,teamXP:o.teamXP,lineageXP:o.lineageXP,currentBelt:o.currentBelt})}return"teamXP"===e?n.sort((e,t)=>t.teamXP-e.teamXP):"lineageXP"===e?n.sort((e,t)=>t.lineageXP-e.lineageXP):"students"===e&&n.sort((e,t)=>t.studentsCount-e.studentsCount),n.slice(0,t)}function S(){const e=parseInt(localStorage.getItem("totalXP")||"0"),t=a();if(t&&t.personalXP!==e){const r=e-(t.personalXP||0);r>0&&f(r)}}function P(){r()&&n(),S();const e=a();e&&(e.currentBelt=c(),o(e))}window.LineageSystem={generateReferralCode:e,getUserReferralCode:t,createReferralLink:function(e=null){const r=e||t();return`${window.location.origin}/index-DUAL-ENTRY.html?ref=${r}`},getReferrerFromURL:r,trackReferralOnStart:n,getUserData:a,getUserDataByCode:u,getDirectStudents:i,calculateTeamXP:g,calculateLineageXP:d,updateUserXP:f,getGymStats:m,getLeaderboard:I,getUserRank:function(e="teamXP"){const t=I(e,1e3),r=a();if(!r)return null;const n=t.findIndex(e=>e.userId===r.userId);return n>=0?n+1:null},setGymName:function(e){const t=a();return!!t&&(t.gymName=e,o(t),!0)},setGymMotto:function(e){const t=a();return!!t&&(t.gymMotto=e,o(t),!0)},syncXPFromLocalStorage:S,initializeLineageSystem:P},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",P):P()}();