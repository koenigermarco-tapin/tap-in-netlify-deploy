const EnhancedAvatarSystem={defaults:{gender:"male",hairColor:"#3b2e1f",skinColor:"#f0d9b5",accessories:[]},getSettings:function(){const t=localStorage.getItem("avatarCustomization");if(t)try{return JSON.parse(t)}catch(t){console.warn("Error parsing avatar settings:",t)}return{...this.defaults}},saveSettings:function(t){const e={...this.getSettings(),...t};return localStorage.setItem("avatarCustomization",JSON.stringify(e)),window.dispatchEvent(new CustomEvent("avatarUpdated",{detail:e})),e},getGender:function(){return this.getSettings().gender||"male"},setGender:function(t){if("male"===t||"female"===t)return this.saveSettings({gender:t});console.warn("Invalid gender:",t)},getHairColor:function(){return this.getSettings().hairColor||"#3b2e1f"},setHairColor:function(t){return this.saveSettings({hairColor:t})},getSkinColor:function(){return this.getSettings().skinColor||"#f0d9b5"},setSkinColor:function(t){return this.saveSettings({skinColor:t})},getAccessories:function(){return this.getSettings().accessories||[]},addAccessory:function(t){const e=this.getAccessories();return e.includes(t)?this.getSettings():(e.push(t),this.saveSettings({accessories:e}))},removeAccessory:function(t){const e=this.getAccessories().filter(e=>e!==t);return this.saveSettings({accessories:e})},getCurrentBelt:function(){if("true"===localStorage.getItem("blackBeltComplete"))return"black";if("true"===localStorage.getItem("brownBeltComplete"))return"brown";if("true"===localStorage.getItem("purpleBeltComplete"))return"purple";if("true"===localStorage.getItem("blueBeltComplete"))return"blue";if("true"===localStorage.getItem("whiteBeltComplete"))return"white";const t=localStorage.getItem("tapinBeltAssessment");if(t)try{const e=JSON.parse(t);if(e.belt)return e.belt.toLowerCase()}catch(t){console.warn("Error parsing assessment:",t)}return"white"},getGiColor:function(){const t={white:"#ffffff",blue:"#2563eb",purple:"#7c3aed",brown:"#92400e",black:"#1f2937"};return t[this.getCurrentBelt()]||t.white},renderAvatar:function(t){if(!t)return;const e=this.getSettings(),r=this.getGiColor(),i=this.getCurrentBelt(),s=t.getAttribute("viewBox")||"0 0 200 300",[n,a,o,l]=s.split(" ").map(Number);t.querySelectorAll(":not(defs)").forEach(t=>t.remove());const c="http://www.w3.org/2000/svg",u=document.createElementNS(c,"rect");u.setAttribute("x",n),u.setAttribute("y",a),u.setAttribute("width",o),u.setAttribute("height",l),u.setAttribute("fill","#f3f4f6"),t.appendChild(u);const d=document.createElementNS(c,"circle");if(d.setAttribute("cx",o/2),d.setAttribute("cy",50),d.setAttribute("r",30),d.setAttribute("fill",e.skinColor),d.classList.add("avatar-head"),t.appendChild(d),"male"===e.gender){const r=document.createElementNS(c,"path");r.setAttribute("d",`M ${o/2-28} 35 Q ${o/2-28} 25 ${o/2} 25 Q ${o/2+28} 25 ${o/2+28} 35 L ${o/2+25} 50 L ${o/2-25} 50 Z`),r.setAttribute("fill",e.hairColor),r.classList.add("avatar-hair"),t.appendChild(r)}else{const r=document.createElementNS(c,"path");r.setAttribute("d",`M ${o/2-30} 35 Q ${o/2-30} 20 ${o/2} 20 Q ${o/2+30} 20 ${o/2+30} 35 L ${o/2+32} 70 L ${o/2-32} 70 Z`),r.setAttribute("fill",e.hairColor),r.classList.add("avatar-hair"),t.appendChild(r)}const h=document.createElementNS(c,"rect");h.setAttribute("x",o/2-30),h.setAttribute("y",80),h.setAttribute("width",60),h.setAttribute("height",80),h.setAttribute("fill",r),h.classList.add("avatar-gi"),t.appendChild(h);const b=document.createElementNS(c,"rect");b.setAttribute("x",o/2-40),b.setAttribute("y",130),b.setAttribute("width",80),b.setAttribute("height",15),b.setAttribute("fill",this.getBeltColor(i)),b.classList.add("avatar-belt",`${i}-belt`),t.appendChild(b);const A=document.createElementNS(c,"line");A.setAttribute("x1",o/2-30),A.setAttribute("y1",90),A.setAttribute("x2",o/2-50),A.setAttribute("y2",120),A.setAttribute("stroke",r),A.setAttribute("stroke-width","8"),t.appendChild(A);const g=document.createElementNS(c,"line");g.setAttribute("x1",o/2+30),g.setAttribute("y1",90),g.setAttribute("x2",o/2+50),g.setAttribute("y2",120),g.setAttribute("stroke",r),g.setAttribute("stroke-width","8"),t.appendChild(g);const f=document.createElementNS(c,"rect");f.setAttribute("x",o/2-30),f.setAttribute("y",160),f.setAttribute("width",20),f.setAttribute("height",60),f.setAttribute("fill",r),t.appendChild(f);const m=document.createElementNS(c,"rect");m.setAttribute("x",o/2+10),m.setAttribute("y",160),m.setAttribute("width",20),m.setAttribute("height",60),m.setAttribute("fill",r),t.appendChild(m);const p=document.createElementNS(c,"ellipse");p.setAttribute("cx",o/2-20),p.setAttribute("cy",225),p.setAttribute("rx",15),p.setAttribute("ry",8),p.setAttribute("fill","#333"),t.appendChild(p);const S=document.createElementNS(c,"ellipse");S.setAttribute("cx",o/2+20),S.setAttribute("cy",225),S.setAttribute("rx",15),S.setAttribute("ry",8),S.setAttribute("fill","#333"),t.appendChild(S),e.accessories.forEach(e=>{this.renderAccessory(t,e,o,l)})},getBeltColor:function(t){const e={white:"#FFFFFF",blue:"#1e40af",purple:"#7c3aed",brown:"#92400e",black:"#1f2937"};return e[t]||e.white},renderAccessory:function(t,e,r,i){console.log("Rendering accessory:",e)},init:function(){document.querySelectorAll(".avatar-svg, .martial-artist, [data-avatar]").forEach(t=>{this.renderAvatar(t)}),window.addEventListener("avatarUpdated",()=>{document.querySelectorAll(".avatar-svg, .martial-artist, [data-avatar]").forEach(t=>{this.renderAvatar(t)})})}};window.EnhancedAvatarSystem=EnhancedAvatarSystem,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>EnhancedAvatarSystem.init()):EnhancedAvatarSystem.init();