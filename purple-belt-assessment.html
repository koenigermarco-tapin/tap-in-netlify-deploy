<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üü£ Purple Belt Assessment | TAP-IN</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 25px; border-bottom: 3px solid #f0f0f0; }
        .header h1 { color: #6d28d9; font-size: 2.3em; margin-bottom: 15px; }
        .header .subtitle { color: #666; font-size: 1.1em; margin-bottom: 10px; }
        .header .duration { color: #999; font-size: 0.9em; font-style: italic; }
        
        .progress-bar { position: sticky; top: 10px; background: white; padding: 15px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .progress-text { text-align: center; color: #666; font-size: 0.9em; margin-bottom: 8px; }
        .progress-fill { height: 8px; background: linear-gradient(90deg, #7c3aed 0%, #6d28d9 100%); border-radius: 10px; overflow: hidden; }
        .progress-fill-bar { background: linear-gradient(90deg, #7c3aed 0%, #6d28d9 100%); height: 100%; width: 0%; transition: width 0.3s ease; }
        
        .section-header { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; }
        .section-header h3 { font-size: 1.2em; margin-bottom: 5px; }
        
        .question-card { background: #f8f9fa; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
        .question-number { color: #6d28d9; font-weight: bold; font-size: 0.9em; margin-bottom: 10px; }
        .question-text { font-size: 1.2em; color: #333; margin-bottom: 25px; font-weight: 500; line-height: 1.5; }
        
        .choice-container { display: flex; flex-direction: column; gap: 12px; }
        .choice-option { padding: 15px 20px; background: white; border: 3px solid #cbd5e1; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: left; font-size: 1em; color: #1e293b; font-weight: 600; }
        .choice-option:hover { border-color: #7c3aed; background: #f3e8ff; }
        .choice-option.selected { border-color: #7c3aed; background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; }
        
        .nav-buttons { display: flex; gap: 15px; justify-content: space-between; margin-top: 25px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }
        .btn-primary { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .results-container { display: none; }
        .results-container.active { display: block; }
        
        .graduation-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .graduation-modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 40px; max-width: 600px; text-align: center; position: relative; animation: modalPop 0.5s ease; }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .confetti-animation { font-size: 3rem; margin-bottom: 20px; }
        .belt-transition { display: flex; justify-content: center; align-items: center; gap: 30px; margin: 30px 0; font-size: 4rem; }
        .belt-transition .arrow { font-size: 2rem; color: #7c3aed; }
        .graduation-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
        .stat { text-align: center; }
        .stat .value { font-size: 2.5rem; font-weight: 800; color: #7c3aed; }
        .stat .label { font-size: 0.9rem; color: #666; margin-top: 5px; }
        .graduation-message { text-align: left; margin: 30px 0; line-height: 1.8; color: #333; }
        .graduation-message ul { margin: 15px 0 15px 20px; }
        .graduation-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap; }
        .btn-large { padding: 18px 40px; font-size: 1.2em; }
        .bjj-wisdom { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; font-style: italic; color: #666; }
        
        .retry-message { background: #fff5f0; border: 2px solid #f59e0b; border-radius: 15px; padding: 30px; margin: 30px 0; text-align: center; }
        .retry-message h3 { color: #92400e; margin-bottom: 15px; }
        .retry-message p { color: #78350f; line-height: 1.7; }
        
        @media (max-width: 768px) {
            .container { padding: 25px; }
            .header h1 { font-size: 2em; }
            .graduation-stats { grid-template-columns: 1fr; }
            .belt-transition { font-size: 3rem; gap: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="assessmentForm">
            <div class="header">
                <h1>üü£ Purple Belt Assessment</h1>
                <p class="subtitle">Test Your Mastery Before Advancing to Brown Belt</p>
                <p class="duration">‚è±Ô∏è 20-25 Minutes ‚Ä¢ 25 Questions ‚Ä¢ 75% Required to Pass</p>
            </div>

            <div id="introSection" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #7c3aed;">
                <h3 style="color: #333; margin-bottom: 15px;">üéì Ready to Graduate?</h3>
                <p style="color: #666; line-height: 1.7; margin-bottom: 15px;">
                    <strong>You've completed all 4 Purple Belt stripes!</strong> This assessment tests your mastery of team alignment, healthy conflict, collective accountability, and results focus. You need to score <strong>75% or higher (19/25 correct)</strong> to advance to Brown Belt.
                </p>
                <ul style="color: #666; line-height: 1.8; margin-left: 20px; margin-bottom: 15px;">
                    <li><strong>25 questions</strong> - Covering all 4 Purple Belt stripes</li>
                    <li><strong>75% pass rate</strong> - 19 correct answers required</li>
                    <li><strong>Unlimited retakes</strong> - Learn and try again</li>
                    <li><strong>Graduation ceremony</strong> - Celebrate your achievement!</li>
                </ul>
                <p style="color: #666; line-height: 1.7; margin-top: 15px; padding: 15px; background: #f3e8ff; border-radius: 8px; font-size: 0.95em;">
                    <strong>ü•ã In BJJ:</strong> "A brown belt is someone who can teach others and build systems. You've learned to work with teams. Now comes the mastery of systems and strategy."
                </p>
                <button onclick="startAssessment()" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3); display: block; margin: 20px auto 0; width: auto;">
                    Begin Assessment ‚Üí
                </button>
            </div>

            <div class="progress-bar" style="display: none;" id="progressBarContainer">
                <div class="progress-text">Question <span id="currentQ">1</span> of 25</div>
                <div class="progress-fill">
                    <div class="progress-fill-bar" id="progressBar"></div>
                </div>
            </div>

            <div id="questionContainer" style="display: none;"></div>

            <div class="nav-buttons" style="display: none;" id="navButtons">
                <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" disabled>‚Üê Previous</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>Next ‚Üí</button>
            </div>
        </div>

        <div id="resultsContainer" class="results-container"></div>
    </div>

    <!-- Graduation Modal -->
    <div class="graduation-modal" id="graduationModal">
        <div class="modal-content">
            <div class="confetti-animation">üéâüéä‚ú®</div>
            <h1>ü•ã Congratulations!</h1>
            <div class="belt-transition">
                <div class="old-belt">üü£</div>
                <div class="arrow">‚Üí</div>
                <div class="new-belt">üü§</div>
            </div>
            <h2 style="color: #7c3aed; margin: 20px 0;">You've Earned Your Brown Belt!</h2>
            <div class="graduation-stats" id="graduationStats"></div>
            <div class="graduation-message" id="graduationMessage"></div>
            <div class="graduation-actions">
                <button class="btn btn-primary btn-large" onclick="advanceToBrownBelt()">üü§ Begin Brown Belt Journey ‚Üí</button>
                <button class="btn btn-secondary" onclick="shareGraduation()">üì± Share Achievement</button>
            </div>
            <div class="bjj-wisdom" id="bjjWisdom"></div>
        </div>
    </div>

    <script>
        const questions = [
            // STRIPE 1: Team Alignment & Shared Goals (7 questions)
            {
                stripe: 1,
                stripeName: 'Team Alignment',
                question: 'The foundation of commitment is:',
                options: [
                    { text: 'Clear vision alignment', value: 'correct', correct: true },
                    { text: 'Individual performance', value: 'incorrect', correct: false },
                    { text: 'Competitive pressure', value: 'incorrect', correct: false },
                    { text: 'External rewards', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 1,
                stripeName: 'Team Alignment',
                question: 'SMART goals are most effective because they:',
                options: [
                    { text: 'Create clarity and focus', value: 'correct', correct: true },
                    { text: 'Are easy to remember', value: 'incorrect', correct: false },
                    { text: 'Require less planning', value: 'incorrect', correct: false },
                    { text: 'Work for everyone', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 1,
                stripeName: 'Team Alignment',
                question: 'OKRs work because they:',
                options: [
                    { text: 'Separate WHAT (objective) from HOW (key results)', value: 'correct', correct: true },
                    { text: 'Are shorter than other goal frameworks', value: 'incorrect', correct: false },
                    { text: 'Don\'t require measurement', value: 'incorrect', correct: false },
                    { text: 'Focus only on outcomes', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 1,
                stripeName: 'Team Alignment',
                question: 'The best teams practice "disagree and commit" which means:',
                options: [
                    { text: 'Committing to move forward even when you disagree', value: 'correct', correct: true },
                    { text: 'Agreeing on everything before moving forward', value: 'incorrect', correct: false },
                    { text: 'Only committing when you fully agree', value: 'incorrect', correct: false },
                    { text: 'Avoiding disagreement entirely', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 1,
                stripeName: 'Team Alignment',
                question: 'Role clarity enables commitment because:',
                options: [
                    { text: 'People know their responsibilities and can commit', value: 'correct', correct: true },
                    { text: 'It reduces the need for communication', value: 'incorrect', correct: false },
                    { text: 'It eliminates all conflict', value: 'incorrect', correct: false },
                    { text: 'It makes decisions faster', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 1,
                stripeName: 'Team Alignment',
                question: 'Quarterly planning creates:',
                options: [
                    { text: 'Rhythm and clarity', value: 'correct', correct: true },
                    { text: 'More meetings', value: 'incorrect', correct: false },
                    { text: 'Rigid structures', value: 'incorrect', correct: false },
                    { text: 'Less flexibility', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 1,
                stripeName: 'Team Alignment',
                question: 'Vision alignment requires:',
                options: [
                    { text: 'Regular check-ins and course correction', value: 'correct', correct: true },
                    { text: 'One-time communication', value: 'incorrect', correct: false },
                    { text: 'Perfect understanding from the start', value: 'incorrect', correct: false },
                    { text: 'Written documentation only', value: 'incorrect', correct: false }
                ]
            },
            // STRIPE 2: Healthy Conflict (6 questions)
            {
                stripe: 2,
                stripeName: 'Healthy Conflict',
                question: 'The best teams view conflict as:',
                options: [
                    { text: 'Healthy and necessary for good decisions', value: 'correct', correct: true },
                    { text: 'Something to avoid at all costs', value: 'incorrect', correct: false },
                    { text: 'A sign of dysfunction', value: 'incorrect', correct: false },
                    { text: 'Only acceptable in private', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 2,
                stripeName: 'Healthy Conflict',
                question: 'Productive debate focuses on:',
                options: [
                    { text: 'Ideas, not personalities', value: 'correct', correct: true },
                    { text: 'Winning the argument', value: 'incorrect', correct: false },
                    { text: 'Proving others wrong', value: 'incorrect', correct: false },
                    { text: 'Avoiding disagreement', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 2,
                stripeName: 'Healthy Conflict',
                question: 'Peer accountability is more effective than top-down because:',
                options: [
                    { text: 'It comes from relationships and respect', value: 'correct', correct: true },
                    { text: 'It requires less effort', value: 'incorrect', correct: false },
                    { text: 'It avoids hierarchy', value: 'incorrect', correct: false },
                    { text: 'It happens automatically', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 2,
                stripeName: 'Healthy Conflict',
                question: 'Fighting fair means:',
                options: [
                    { text: 'Disagreeing without being disagreeable', value: 'correct', correct: true },
                    { text: 'Never raising your voice', value: 'incorrect', correct: false },
                    { text: 'Always being polite', value: 'incorrect', correct: false },
                    { text: 'Avoiding all conflict', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 2,
                stripeName: 'Healthy Conflict',
                question: 'Healthy tension is necessary because:',
                options: [
                    { text: 'It creates better decisions through discussion', value: 'correct', correct: true },
                    { text: 'It keeps people on their toes', value: 'incorrect', correct: false },
                    { text: 'It prevents complacency', value: 'incorrect', correct: false },
                    { text: 'It shows who\'s in charge', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 2,
                stripeName: 'Healthy Conflict',
                question: 'The best way to engage in conflict is:',
                options: [
                    { text: 'Directly and respectfully', value: 'correct', correct: true },
                    { text: 'Through a manager', value: 'incorrect', correct: false },
                    { text: 'In private only', value: 'incorrect', correct: false },
                    { text: 'By avoiding it', value: 'incorrect', correct: false }
                ]
            },
            // STRIPE 3: Collective Accountability (6 questions)
            {
                stripe: 3,
                stripeName: 'Collective Accountability',
                question: 'Peer accountability is more powerful than top-down because:',
                options: [
                    { text: 'It comes from relationships and mutual respect', value: 'correct', correct: true },
                    { text: 'It requires less management', value: 'incorrect', correct: false },
                    { text: 'It happens automatically', value: 'incorrect', correct: false },
                    { text: 'It avoids hierarchy', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 3,
                stripeName: 'Collective Accountability',
                question: 'Maintaining standards means:',
                options: [
                    { text: 'Not lowering the bar when people struggle', value: 'correct', correct: true },
                    { text: 'Being strict about everything', value: 'incorrect', correct: false },
                    { text: 'Never making exceptions', value: 'incorrect', correct: false },
                    { text: 'Enforcing rules rigidly', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 3,
                stripeName: 'Collective Accountability',
                question: 'Accountability culture is created by:',
                options: [
                    { text: 'Modeling accountability in your own behavior', value: 'correct', correct: true },
                    { text: 'Setting strict rules', value: 'incorrect', correct: false },
                    { text: 'Monitoring everyone closely', value: 'incorrect', correct: false },
                    { text: 'Punishing mistakes', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 3,
                stripeName: 'Collective Accountability',
                question: 'The best way to give accountability feedback is:',
                options: [
                    { text: 'Directly, focusing on behavior not person', value: 'correct', correct: true },
                    { text: 'Through a manager', value: 'incorrect', correct: false },
                    { text: 'In group settings', value: 'incorrect', correct: false },
                    { text: 'Only when asked', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 3,
                stripeName: 'Collective Accountability',
                question: 'You can receive accountability feedback without defensiveness by:',
                options: [
                    { text: 'Approaching it with a learning mindset', value: 'correct', correct: true },
                    { text: 'Ignoring it', value: 'incorrect', correct: false },
                    { text: 'Defending your actions', value: 'incorrect', correct: false },
                    { text: 'Only accepting it from superiors', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 3,
                stripeName: 'Collective Accountability',
                question: 'Accountability is reinforced by:',
                options: [
                    { text: 'Holding each other accountable for commitments', value: 'correct', correct: true },
                    { text: 'Setting more rules', value: 'incorrect', correct: false },
                    { text: 'Monitoring closely', value: 'incorrect', correct: false },
                    { text: 'Punishing failures', value: 'incorrect', correct: false }
                ]
            },
            // STRIPE 4: Results Focus (6 questions)
            {
                stripe: 4,
                stripeName: 'Results Focus',
                question: 'Results matter more than activity because:',
                options: [
                    { text: 'Outcomes drive success, not just effort', value: 'correct', correct: true },
                    { text: 'Activity is always wasteful', value: 'incorrect', correct: false },
                    { text: 'Results are easier to measure', value: 'incorrect', correct: false },
                    { text: 'Activity doesn\'t matter', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 4,
                stripeName: 'Results Focus',
                question: 'The best metrics to track are:',
                options: [
                    { text: 'Metrics that actually drive results', value: 'correct', correct: true },
                    { text: 'Easy-to-measure metrics', value: 'incorrect', correct: false },
                    { text: 'Vanity metrics that look good', value: 'incorrect', correct: false },
                    { text: 'All available metrics', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 4,
                stripeName: 'Results Focus',
                question: 'Collective results matter more than individual success because:',
                options: [
                    { text: 'Team success drives organizational performance', value: 'correct', correct: true },
                    { text: 'Individual success doesn\'t matter', value: 'incorrect', correct: false },
                    { text: 'It\'s easier to measure', value: 'incorrect', correct: false },
                    { text: 'It requires less effort', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 4,
                stripeName: 'Results Focus',
                question: 'You can distinguish activity from achievement by:',
                options: [
                    { text: 'Focusing on outcomes, not just effort', value: 'correct', correct: true },
                    { text: 'Measuring hours worked', value: 'incorrect', correct: false },
                    { text: 'Counting tasks completed', value: 'incorrect', correct: false },
                    { text: 'Tracking all activities', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 4,
                stripeName: 'Results Focus',
                question: 'Leading indicators are better than lagging indicators because:',
                options: [
                    { text: 'They predict results before they happen', value: 'correct', correct: true },
                    { text: 'They\'re easier to measure', value: 'incorrect', correct: false },
                    { text: 'They require less data', value: 'incorrect', correct: false },
                    { text: 'They\'re more accurate', value: 'incorrect', correct: false }
                ]
            },
            {
                stripe: 4,
                stripeName: 'Results Focus',
                question: 'The best way to prioritize is:',
                options: [
                    { text: 'Focus on what produces results', value: 'correct', correct: true },
                    { text: 'Do everything equally', value: 'incorrect', correct: false },
                    { text: 'Focus on what feels good', value: 'incorrect', correct: false },
                    { text: 'Prioritize based on urgency only', value: 'incorrect', correct: false }
                ]
            }
        ];

        const totalQuestions = questions.length;
        const passScore = 19; // 75%

        let currentQuestionIndex = 0;
        let answers = {};

        function startAssessment() {
            // Check if all Purple Belt stripes are complete
            if (localStorage.getItem('purpleBeltStripe4Complete') !== 'true') {
                alert('Please complete all 4 Purple Belt stripes first.');
                window.location.href = 'purple-belt.html';
                return;
            }

            document.getElementById('introSection').style.display = 'none';
            document.getElementById('progressBarContainer').style.display = 'block';
            document.getElementById('questionContainer').style.display = 'block';
            document.getElementById('navButtons').style.display = 'flex';
            
            currentQuestionIndex = 0;
            answers = {};
            renderQuestion(0);
        }

        function renderQuestion(index) {
            const q = questions[index];
            const container = document.getElementById('questionContainer');
            
            let html = '';
            
            // Show section header if new stripe
            if (index === 0 || questions[index - 1].stripe !== q.stripe) {
                html += `
                    <div class="section-header">
                        <h3>Stripe ${q.stripe}: ${q.stripeName}</h3>
                    </div>
                `;
            }
            
            html += `
                <div class="question-card">
                    <div class="question-number">Question ${index + 1} of ${totalQuestions}</div>
                    <div class="question-text">${q.question}</div>
                    <div class="choice-container">
                        ${q.options.map((opt, idx) => `
                            <div class="choice-option ${answers[index] === idx ? 'selected' : ''}" onclick="selectAnswer(${index}, ${idx})">
                                ${opt.text}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            document.getElementById('currentQ').textContent = index + 1;
            updateProgress();
        }

        function selectAnswer(qIndex, optionIndex) {
            answers[qIndex] = optionIndex;
            
            document.querySelectorAll('.choice-option').forEach((opt, idx) => {
                opt.classList.remove('selected');
            });
            
            const selectedOpt = document.querySelectorAll('.choice-option')[optionIndex];
            if (selectedOpt) {
                selectedOpt.classList.add('selected');
            }
            
            document.getElementById('nextBtn').disabled = false;
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                document.getElementById('prevBtn').disabled = false;
                document.getElementById('nextBtn').disabled = !answers[currentQuestionIndex];
                document.getElementById('nextBtn').textContent = 'Next ‚Üí';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showResults();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion(currentQuestionIndex);
                document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
                document.getElementById('nextBtn').disabled = false;
                document.getElementById('nextBtn').textContent = 'Next ‚Üí';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updateProgress() {
            const answered = Object.keys(answers).length;
            const progress = (answered / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            if (currentQuestionIndex === questions.length - 1) {
                document.getElementById('nextBtn').textContent = 'See Results üéØ';
            }
        }

        function showResults() {
            let correct = 0;
            const results = [];
            
            questions.forEach((q, qIndex) => {
                const selectedIndex = answers[qIndex];
                if (selectedIndex !== undefined) {
                    const selected = q.options[selectedIndex];
                    const isCorrect = selected.correct;
                    if (isCorrect) correct++;
                    
                    results.push({
                        question: q.question,
                        selected: selected.text,
                        correct: isCorrect,
                        correctAnswer: q.options.find(o => o.correct).text
                    });
                }
            });
            
            const score = correct;
            const percentage = (score / totalQuestions) * 100;
            const passed = score >= passScore;
            
            document.getElementById('assessmentForm').style.display = 'none';
            document.getElementById('resultsContainer').classList.add('active');
            
            let resultsHTML = `
                <div class="header">
                    <h1>üü£ Assessment Results</h1>
                </div>
            `;
            
            if (passed) {
                showGraduationCeremony(score, percentage);
            } else {
                resultsHTML += `
                    <div class="retry-message">
                        <h3>üìö Keep Learning!</h3>
                        <p><strong>Score: ${score}/${totalQuestions} (${percentage.toFixed(0)}%)</strong></p>
                        <p>You scored ${score} out of ${totalQuestions}. You need ${passScore} correct answers (75%) to pass.</p>
                        <p style="margin-top: 15px;">Review the Purple Belt content and try again. Every attempt helps you learn!</p>
                        <button onclick="window.location.reload()" class="btn btn-primary" style="margin-top: 20px;">üîÑ Retake Assessment</button>
                    </div>
                `;
            }
            
            document.getElementById('resultsContainer').innerHTML = resultsHTML;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showGraduationCeremony(score, percentage) {
            // Trigger confetti
            if (typeof confetti !== 'undefined') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
            
            // Update stats
            document.getElementById('graduationStats').innerHTML = `
                <div class="stat">
                    <div class="value">${score}</div>
                    <div class="label">Correct</div>
                </div>
                <div class="stat">
                    <div class="value">${percentage.toFixed(0)}%</div>
                    <div class="label">Score</div>
                </div>
                <div class="stat">
                    <div class="value">1000</div>
                    <div class="label">XP Earned</div>
                </div>
            `;
            
            document.getElementById('graduationMessage').innerHTML = `
                <h3 style="color: #7c3aed; margin-bottom: 15px;">üéâ Purple Belt Complete!</h3>
                <p>You've mastered team alignment, healthy conflict, collective accountability, and results focus. You're ready for Brown Belt!</p>
                <ul>
                    <li>‚úÖ Team Alignment & Shared Goals</li>
                    <li>‚úÖ Healthy Conflict Engagement</li>
                    <li>‚úÖ Collective Accountability</li>
                    <li>‚úÖ Results Focus & Measurement</li>
                </ul>
            `;
            
            document.getElementById('bjjWisdom').innerHTML = `
                <strong>ü•ã BJJ Wisdom:</strong> "A brown belt is someone who can teach others and build systems. You've learned to work with teams. Now comes the mastery of systems and strategy."
            `;
            
            document.getElementById('graduationModal').classList.add('active');
            
            // Save completion
            localStorage.setItem('purpleBeltComplete', 'true');
            localStorage.setItem('purpleBeltCompletedDate', new Date().toISOString());
            localStorage.setItem('currentBelt', 'Brown');
            localStorage.setItem('brownBeltUnlocked', 'true');
            
            // Award XP
            const currentXP = parseInt(localStorage.getItem('totalXP') || '0');
            localStorage.setItem('totalXP', (currentXP + 1000).toString());
            
            // Update displays if available
            if (typeof TapInXP !== 'undefined') {
                TapInXP.updateXPDisplays();
            }
        }

        function advanceToBrownBelt() {
            window.location.href = 'brown-belt.html';
        }

        function shareGraduation() {
            const text = `üéâ I just earned my Purple Belt in TAP-IN! üü£\n\nMastered team alignment, healthy conflict, accountability, and results focus. Ready for Brown Belt! ü•ã`;
            if (navigator.share) {
                navigator.share({ text });
            } else {
                navigator.clipboard.writeText(text);
                alert('Achievement copied to clipboard!');
            }
        }
    </script>
<!-- TAP-IN Utilities -->
<script src="js/shared-utilities.js"></script>
<script src="js/global-error-handler.js"></script>
<script src="js/storage-health.js"></script>
</body>
</html>
