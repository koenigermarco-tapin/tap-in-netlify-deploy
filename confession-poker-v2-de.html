<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Performance: Resource Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <!-- Performance: Resource Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <title>Confession Poker - Multiplayer Trust Game | Tap-In</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase for Multi-Device Mode -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .pulse-animation { animation: pulse 2s infinite; }
        .shake-animation { animation: shake 0.5s ease-in-out; }
        .bounce-animation { animation: bounce 1s infinite; }
        
        .card-flip {
            perspective: 1000px;
        }
        .card-flip-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flip.flipped .card-flip-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
        }
    </style>

    <style>
        /* Responsive Design */
        @media (max-width: 768px) {
            body { padding: 10px !important; }
            .container { max-width: 100% !important; padding: 10px !important; }
            h1 { font-size: 24px !important; }
            h2 { font-size: 20px !important; }
            button { padding: 12px 20px !important; font-size: 14px !important; }
            .card, .game-card { padding: 20px !important; }
        }
        @media (max-width: 480px) {
            body { padding: 5px !important; }
            h1 { font-size: 20px !important; }
            button { padding: 10px 16px !important; font-size: 12px !important; }
        }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#c62828">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TAP-IN">
    <link rel="stylesheet" href="css/pwa-install-banner.css">
</head>
<body class="bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 min-h-screen">
    <a href="#main-content" class="skip-link" style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden;">
        Zum Hauptinhalt springen
    </a>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Confession Card Database - 52 CARDS (German)
        const CONFESSION_CARDS = [
            // White Belt - Vulnerability (10 cards)
            { id: 1, text: "Ich habe einmal jemand anderem die Schuld f√ºr meinen Fehler bei der Arbeit gegeben", category: "white", intensity: 2 },
            { id: 2, text: "Ich habe so getan, als w√§re ich besch√§ftigt, um jemandem nicht helfen zu m√ºssen", category: "white", intensity: 1 },
            { id: 3, text: "Ich habe hinter dem R√ºcken eines Teammitglieds √ºber ihn/sie gel√§stert", category: "white", intensity: 3 },
            { id: 4, text: "Ich habe mir die Anerkennung f√ºr eine Idee genommen, die nicht ganz meine war", category: "white", intensity: 4 },
            { id: 5, text: "Ich habe gelogen, dass ich eine wichtige E-Mail/Dokument gelesen habe", category: "white", intensity: 2 },
            { id: 6, text: "Ich habe mich krank gemeldet, obwohl ich gar nicht krank war", category: "white", intensity: 2 },
            { id: 7, text: "Ich habe jemanden aufgrund seines Aussehens beurteilt", category: "white", intensity: 3 },
            { id: 8, text: "Ich habe so getan, als w√ºrde ich etwas verstehen, obwohl ich v√∂llig √ºberfordert war", category: "white", intensity: 2 },
            { id: 9, text: "Ich habe in einem Vorstellungsgespr√§ch schlecht √ºber einen fr√ºheren Arbeitgeber gesprochen", category: "white", intensity: 3 },
            { id: 10, text: "Ich habe B√ºromaterial ohne Erlaubnis mit nach Hause genommen", category: "white", intensity: 1 },
            
            // Blue Belt - Conflict (10 cards)
            { id: 11, text: "Ich habe ein schwieriges Gespr√§ch √ºber einen Monat lang vermieden", category: "blue", intensity: 2 },
            { id: 12, text: "Ich habe in einem Meeting etwas zugestimmt und mich dann sp√§ter dar√ºber beschwert", category: "blue", intensity: 3 },
            { id: 13, text: "Ich habe geschwiegen, als ich mit einer schlechten Entscheidung nicht einverstanden war", category: "blue", intensity: 3 },
            { id: 14, text: "Ich habe eine passiv-aggressive E-Mail geschickt, statt direkt zu reden", category: "blue", intensity: 2 },
            { id: 15, text: "Ich habe eine Freundschaft durch Ghosting beendet, statt ein Gespr√§ch zu f√ºhren", category: "blue", intensity: 4 },
            { id: 16, text: "Ich habe jemandes Vorgesetzten in CC gesetzt, um ihn/sie schlecht dastehen zu lassen", category: "blue", intensity: 4 },
            { id: 17, text: "Ich habe jemandes Feedback ignoriert, weil ich ihn/sie nicht mochte", category: "blue", intensity: 3 },
            { id: 18, text: "Ich habe eine toxische Arbeitsumgebung verlassen, ohne ehrliches Exit-Feedback zu geben", category: "blue", intensity: 2 },
            { id: 19, text: "Ich habe mich bei anderen √ºber jemanden beschwert, statt es direkt anzusprechen", category: "blue", intensity: 3 },
            { id: 20, text: "Ich habe Augenkontakt vermieden, um einem Gespr√§ch auszuweichen", category: "blue", intensity: 1 },
            
            // Purple Belt - Commitment (12 cards)
            { id: 21, text: "Ich habe 'ja' zu einem Commitment gesagt, obwohl ich wusste, dass ich es nicht einhalten werde", category: "purple", intensity: 3 },
            { id: 22, text: "Ich habe etwas aufgegeben, wozu ich mich verpflichtet hatte, als es schwer wurde", category: "purple", intensity: 3 },
            { id: 23, text: "Ich habe jemandem ein Versprechen gegeben und es komplett vergessen", category: "purple", intensity: 2 },
            { id: 24, text: "Ich war 'zu besch√§ftigt' f√ºr etwas, das ich tats√§chlich einfach nicht priorisiert habe", category: "purple", intensity: 2 },
            { id: 25, text: "Ich habe ein Teamprojekt vor Abschluss aufgegeben", category: "purple", intensity: 4 },
            { id: 26, text: "Ich habe ein ehrenamtliches Commitment durch Ghosting nicht erf√ºllt", category: "purple", intensity: 3 },
            { id: 27, text: "Ich habe mich zu einem Deadline verpflichtet, von dem ich wusste, dass es unm√∂glich ist", category: "purple", intensity: 3 },
            { id: 28, text: "Ich habe Pl√§ne in letzter Minute ohne guten Grund abgesagt", category: "purple", intensity: 2 },
            { id: 29, text: "Ich habe etwas halbherzig gemacht, wozu ich mich verpflichtet hatte, es gut zu machen", category: "purple", intensity: 3 },
            { id: 30, text: "Ich bin einem Komitee/Gruppe beigetreten und nie erschienen", category: "purple", intensity: 3 },
            { id: 31, text: "Ich habe einen Neujahrsvorsatz bis zum 15. Januar gebrochen", category: "purple", intensity: 1 },
            { id: 32, text: "Ich habe mich verpflichtet, etwas zu lernen, und nach einer Woche aufgegeben", category: "purple", intensity: 2 },
            
            // Brown Belt - Accountability (10 cards)
            { id: 33, text: "Ich wusste, dass jemand unterperformt, habe aber nichts gesagt", category: "brown", intensity: 3 },
            { id: 34, text: "Ich habe jemanden die Schuld f√ºr einen gemeinsamen Fehler √ºbernehmen lassen", category: "brown", intensity: 4 },
            { id: 35, text: "Ich habe mich nicht an die gleichen Standards gehalten, die ich von anderen erwarte", category: "brown", intensity: 3 },
            { id: 36, text: "Ich habe eine Ausrede gemacht, statt zuzugeben, dass ich versagt habe", category: "brown", intensity: 2 },
            { id: 37, text: "Ich habe einen Teamwert oder eine Regel ignoriert, wenn es unpraktisch war", category: "brown", intensity: 3 },
            { id: 38, text: "Ich wusste, dass jemand gegen eine Richtlinie verst√∂√üt, habe aber geschwiegen", category: "brown", intensity: 4 },
            { id: 39, text: "Ich habe jemandem eine gute Bewertung gegeben, die er/sie nicht verdient hat, um Konflikte zu vermeiden", category: "brown", intensity: 4 },
            { id: 40, text: "Ich habe jemanden k√§mpfen sehen und keine Hilfe angeboten", category: "brown", intensity: 2 },
            { id: 41, text: "Ich habe jemandes schlechte Leistung aus Freundschaft gedeckt", category: "brown", intensity: 3 },
            { id: 42, text: "Ich habe nicht gesprochen, als ich unethisches Verhalten sah", category: "brown", intensity: 5 },
            
            // Black Belt - Results (10 cards)
            { id: 43, text: "Ich habe gutes Aussehen √ºber tats√§chliche Ergebnisse priorisiert", category: "black", intensity: 3 },
            { id: 44, text: "Ich habe meinen Status gesch√ºtzt, statt das Beste f√ºr das Team zu tun", category: "black", intensity: 4 },
            { id: 45, text: "Ich habe einen Shortcut genommen, der langfristige Ergebnisse f√ºr kurzfristige Siege geschadet hat", category: "black", intensity: 3 },
            { id: 46, text: "Ich habe individuellen Erfolg gefeiert, w√§hrend das Team versagt hat", category: "black", intensity: 4 },
            { id: 47, text: "Ich wusste, dass wir auf ein Scheitern zusteuerten, habe aber nicht gesprochen", category: "black", intensity: 5 },
            { id: 48, text: "Ich habe mit meinen eigenen Teammitgliedern konkurriert, statt zu kooperieren", category: "black", intensity: 3 },
            { id: 49, text: "Ich habe meine Ziele niedrig angesetzt, um sie leichter zu erreichen", category: "black", intensity: 3 },
            { id: 50, text: "Ich habe Informationen zur√ºckgehalten, um meine Wichtigkeit zu erhalten", category: "black", intensity: 4 },
            { id: 51, text: "Ich habe einen Kunden scheitern lassen, weil ihm zu helfen nicht in meinen KPIs war", category: "black", intensity: 5 },
            { id: 52, text: "Ich habe f√ºr meinen Bonus optimiert, statt f√ºr das, was richtig f√ºr das Business war", category: "black", intensity: 4 },
        ];

        // Firebase Configuration - Using a public demo database
        // REPLACE WITH YOUR OWN FIREBASE CONFIG FOR PRODUCTION
        
    // ============================================
    // PRODUCTION BACKEND CONFIG
    // ============================================
    // TODO: Replace demo config with production:
    // 1. Option A: Use Supabase Real-time (recommended)
    //    - See PRODUCTION-GAME-BACKEND-SETUP.md
    // 2. Option B: Use Production Firebase
    //    - Create Firebase project
    //    - Get production keys
    //    - Replace config below
    // ============================================
const firebaseConfig = {
            apiKey: "AIzaSyBvK_vZ3vXj5k5L0Qp6X9K5Z6Yq8L0A5B0",
            authDomain: "demo-confession-poker.firebaseapp.com",
            databaseURL: "https://demo-confession-poker-default-rtdb.firebaseio.com",
            projectId: "demo-confession-poker"
        };

        // Initialize Firebase
        let firebaseApp = null;
        try {
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            }
        } catch (error) {
            console.log('‚ÑπÔ∏è Using localStorage mode:', error);
        }

        // Game Room Manager
        class GameRoom {
            constructor(roomCode, multiDevice = false) {
                this.roomCode = roomCode;
                this.multiDevice = multiDevice && firebaseApp !== null;
                this.storageKey = `confession-poker-${roomCode}`;
                
                if (this.multiDevice) {
                    this.dbRef = firebase.database().ref(`rooms/${roomCode}`);
                }
            }

            async getState() {
                if (this.multiDevice) {
                    const snapshot = await this.dbRef.once('value');
                    return snapshot.val();
                }
                const data = localStorage.getItem(this.storageKey);
                return data ? JSON.parse(data) : null;
            }

            async setState(state) {
                if (this.multiDevice) {
                    await this.dbRef.set(state);
                } else {
                    localStorage.setItem(this.storageKey, JSON.stringify(state));
                    window.dispatchEvent(new Event('storage'));
                }
            }

            subscribe(callback) {
                if (this.multiDevice) {
                    this.dbRef.on('value', (snapshot) => {
                        callback(snapshot.val());
                    });
                    return () => this.dbRef.off('value');
                } else {
                    const handler = () => {
                        const data = localStorage.getItem(this.storageKey);
                        callback(data ? JSON.parse(data) : null);
                    };
                    window.addEventListener('storage', handler);
                    return () => window.removeEventListener('storage', handler);
                }
            }
        }

        // Main App Component
        function ConfessionPoker() {
            // State
            const [screen, setScreen] = useState('mode-select'); // mode-select, lobby, game, reveal, end
            const [gameMode, setGameMode] = useState(null); // pass-play, multi-device
            const [roomCode, setRoomCode] = useState('');
            const [myName, setMyName] = useState('');
            const [players, setPlayers] = useState([]);
            const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
            const [currentCard, setCurrentCard] = useState(null);
            const [activePlayerRating, setActivePlayerRating] = useState(null);
            const [guesses, setGuesses] = useState({});
            const [scores, setScores] = useState({});
            const [round, setRound] = useState(0);
            const [usedCards, setUsedCards] = useState([]);
            const [showReveal, setShowReveal] = useState(false);
            const [challengeActive, setChallengeActive] = useState(false);
            const [challengeVotes, setChallengeVotes] = useState({});

            const roomRef = useRef(null);

            // Sync with room
            useEffect(() => {
                if (!roomCode || screen === 'mode-select') return;

                const room = new GameRoom(roomCode, gameMode === 'multi-device');
                roomRef.current = room;

                const unsubscribe = room.subscribe((state) => {
                    if (state) {
                        setPlayers(state.players || []);
                        setCurrentPlayerIndex(state.currentPlayerIndex || 0);
                        setCurrentCard(state.currentCard || null);
                        setActivePlayerRating(state.activePlayerRating || null);
                        setGuesses(state.guesses || {});
                        setScores(state.scores || {});
                        setRound(state.round || 0);
                        setUsedCards(state.usedCards || []);
                        if (state.screen) setScreen(state.screen);
                    }
                });

                // Initialize room if needed
                room.getState().then(state => {
                    if (!state) {
                        room.setState({
                            players: [],
                            currentPlayerIndex: 0,
                            scores: {},
                            round: 0,
                            usedCards: [],
                            screen: 'lobby'
                        });
                    }
                });

                return unsubscribe;
            }, [roomCode, gameMode]);

            // Helper: Update room state
            const updateRoom = async (updates) => {
                if (!roomRef.current) return;
                const state = await roomRef.current.getState();
                await roomRef.current.setState({ ...state, ...updates });
            };

            // Mode selection
            const selectMode = (mode) => {
                setGameMode(mode);
                setScreen('lobby');
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                setRoomCode(code);
            };

            // Join room
            const joinRoom = (code, name) => {
                setRoomCode(code);
                setMyName(name);
                setGameMode('multi-device');
                setScreen('lobby');
            };

            // Add player
            const addPlayer = async (name) => {
                if (!name.trim() || !roomRef.current) return;
                
                const state = await roomRef.current.getState();
                if (state.players.some(p => p.name === name)) {
                    alert('Name bereits vergeben!');
                    return;
                }

                const newPlayer = { name, id: Date.now() };
                await updateRoom({
                    players: [...state.players, newPlayer],
                    scores: { ...state.scores, [name]: 0 }
                });

                setMyName(name);
            };

            // Start game
            const startGame = async () => {
                const state = await roomRef.current.getState();
                if (state.players.length < 3) {
                    alert('Mindestens 3 Spieler ben√∂tigt!');
                    return;
                }

                await updateRoom({
                    screen: 'game',
                    round: 1,
                    currentPlayerIndex: 0
                });
            };

            // Draw card
            const drawCard = async () => {
                const state = await roomRef.current.getState();
                const available = CONFESSION_CARDS.filter(c => !state.usedCards.includes(c.id));
                
                if (available.length === 0) {
                    alert('Alle Karten verwendet!');
                    await updateRoom({ screen: 'end' });
                    return;
                }

                const card = available[Math.floor(Math.random() * available.length)];
                await updateRoom({
                    currentCard: card,
                    usedCards: [...state.usedCards, card.id],
                    activePlayerRating: null,
                    guesses: {}
                });
            };

            // Submit rating
            const submitRating = async (rating) => {
                await updateRoom({ activePlayerRating: rating });
            };

            // Submit guess
            const submitGuess = async (guess) => {
                const state = await roomRef.current.getState();
                await updateRoom({
                    guesses: { ...state.guesses, [myName]: guess }
                });
            };

            // Reveal results
            const revealResults = async () => {
                setShowReveal(true);
                const state = await roomRef.current.getState();
                
                const newScores = { ...state.scores };
                Object.entries(state.guesses).forEach(([name, guess]) => {
                    const diff = Math.abs(guess - state.activePlayerRating);
                    const points = diff === 0 ? 3 : diff === 1 ? 2 : diff === 2 ? 1 : 0;
                    newScores[name] = (newScores[name] || 0) + points;
                });

                setTimeout(async () => {
                    setShowReveal(false);
                    await updateRoom({ scores: newScores });
                    nextPlayer();
                }, 3000);
            };

            // Next player
            const nextPlayer = async () => {
                const state = await roomRef.current.getState();
                const nextIndex = (state.currentPlayerIndex + 1) % state.players.length;
                const newRound = nextIndex === 0 ? state.round + 1 : state.round;

                if (newRound > 5) {
                    await updateRoom({ screen: 'end' });
                    return;
                }

                await updateRoom({
                    currentPlayerIndex: nextIndex,
                    currentCard: null,
                    activePlayerRating: null,
                    guesses: {},
                    round: newRound
                });
            };

            // Challenge
            const initiateChallenge = () => {
                setChallengeActive(true);
                setChallengeVotes({});
            };

            const voteChallenge = async (vote) => {
                const newVotes = { ...challengeVotes, [myName]: vote };
                setChallengeVotes(newVotes);

                if (Object.keys(newVotes).length === players.length - 1) {
                    const state = await roomRef.current.getState();
                    const believeCount = Object.values(newVotes).filter(v => v === 'believe').length;
                    const challengeCount = Object.values(newVotes).filter(v => v === 'challenge').length;
                    
                    const newScores = { ...state.scores };
                    const activePlayer = state.players[state.currentPlayerIndex].name;

                    if (challengeCount > believeCount) {
                        newScores[activePlayer] = Math.max(0, (newScores[activePlayer] || 0) - 5);
                    } else {
                        Object.entries(newVotes).forEach(([name, v]) => {
                            if (v === 'challenge') {
                                newScores[name] = Math.max(0, (newScores[name] || 0) - 2);
                            }
                        });
                    }

                    await updateRoom({ scores: newScores });
                    setChallengeActive(false);
                }
            };

            // Reset
            const resetGame = async () => {
                if (roomRef.current) {
                    await roomRef.current.setState({
                        players: [],
                        currentPlayerIndex: 0,
                        scores: {},
                        round: 0,
                        usedCards: [],
                        screen: 'lobby'
                    });
                }
                setScreen('mode-select');
                setGameMode(null);
                setMyName('');
                setRoomCode('');
            };

            // Get current player
            const currentPlayer = players[currentPlayerIndex];
            const isActivePlayer = currentPlayer?.name === myName;
            const allGuessed = Object.keys(guesses).length === players.length - 1;

            // Render Mode Select
            if (screen === 'mode-select') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-2xl w-full">
                            <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-12 shadow-2xl border border-white/20 fade-in">
                                <h1 className="text-6xl font-bold text-white mb-4 text-center">
                                    üÉè Confession Poker
                                </h1>
                                <p className="text-white/80 text-center mb-12 text-lg">
                                    Baue Vertrauen durch Verletzlichkeit und Empathie auf
                                </p>

                                <div className="space-y-6">
                                    <button
                                        onClick={() => selectMode('pass-play')}
                                        className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-6 rounded-2xl font-bold text-xl hover:shadow-2xl transform hover:scale-105 transition"
                                    >
                                        <div className="text-3xl mb-2">üì±</div>
                                        Weitergeben & Spielen
                                        <div className="text-sm font-normal opacity-80 mt-2">
                                            Ein Ger√§t, abwechselnd
                                        </div>
                                    </button>

                                    <button
                                        onClick={() => selectMode('multi-device')}
                                        className="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-8 py-6 rounded-2xl font-bold text-xl hover:shadow-2xl transform hover:scale-105 transition"
                                    >
                                        <div className="text-3xl mb-2">üåê</div>
                                        Multi-Ger√§t
                                        <div className="text-sm font-normal opacity-80 mt-2">
                                            Jeder auf seinem eigenen Handy
                                        </div>
                                    </button>

                                    {gameMode === null && (
                                        <div className="border-t border-white/20 pt-6 mt-6">
                                            <input
                                                type="text"
                                                placeholder="Oder Raumcode eingeben, um beizutreten"
                                                className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3"
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter' && e.target.value) {
                                                        const code = e.target.value.toUpperCase();
                                                        const name = prompt('Gib deinen Namen ein:');
                                                        if (name) joinRoom(code, name);
                                                    }
                                                }}
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Render Lobby
            if (screen === 'lobby') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-2xl w-full">
                            <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl border border-white/20 fade-in">
                                <div className="text-center mb-8">
                                    <h2 className="text-3xl font-bold text-white mb-2">Spiel-Lobby</h2>
                                    <div className="inline-block bg-gradient-to-r from-purple-500/30 to-pink-500/30 rounded-lg px-6 py-3 border border-purple-500/50">
                                        <p className="text-white/60 text-sm">Raumcode</p>
                                        <p className="text-4xl font-mono font-bold text-white tracking-wider">{roomCode}</p>
                                    </div>
                                    <p className="text-white/60 text-sm mt-4">
                                        Modus: {gameMode === 'pass-play' ? 'üì± Weitergeben & Spielen' : 'üåê Multi-Ger√§t'}
                                    </p>
                                </div>

                                {!myName ? (
                                    <div className="mb-8">
                                        <input
                                            type="text"
                                            placeholder="Gib deinen Namen ein"
                                            className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter') {
                                                    addPlayer(e.target.value);
                                                    e.target.value = '';
                                                }
                                            }}
                                        />
                                    </div>
                                ) : (
                                    <>
                                        <div className="mb-6">
                                            <h3 className="text-white font-bold mb-4">
                                                Spieler ({players.length}/8)
                                            </h3>
                                            <div className="space-y-2">
                                                {players.map((player, i) => (
                                                    <div
                                                        key={player.id}
                                                        className="bg-white/5 rounded-lg p-3 flex items-center justify-between slide-in"
                                                    >
                                                        <span className="text-white font-medium">
                                                            {player.name}
                                                            {player.name === myName && (
                                                                <span className="ml-2 text-purple-400 text-sm">(Du)</span>
                                                            )}
                                                        </span>
                                                        <span className="text-green-400 text-sm">‚úì Bereit</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {players.length >= 3 && players[0]?.name === myName && (
                                            <button
                                                onClick={startGame}
                                                className="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-4 rounded-xl font-bold text-xl hover:shadow-lg transform hover:scale-105 transition pulse-animation"
                                            >
                                                Spiel starten
                                            </button>
                                        )}

                                        {players.length < 3 && (
                                            <p className="text-white/60 text-center">
                                                {3 - players.length} weitere(r) Spieler ben√∂tigt
                                            </p>
                                        )}
                                    </>
                                )}

                                <button
                                    onClick={() => {
                                        setScreen('mode-select');
                                        setGameMode(null);
                                        setMyName('');
                                    }}
                                    className="w-full mt-4 text-white/60 hover:text-white transition"
                                >
                                    ‚Üê Zur√ºck
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Render Game
            if (screen === 'game') {
                return (
                    <div className="min-h-screen p-4 md:p-8">
                        <div className="max-w-6xl mx-auto fade-in">
                            {/* Header */}
                            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 shadow-2xl border border-white/20">
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div>
                                        <h2 className="text-2xl font-bold text-white">Runde {round}/5</h2>
                                        <p className="text-white/60">Raum: {roomCode}</p>
                                    </div>
                                    <div className="text-center md:text-right">
                                        <p className="text-white/60 text-sm">Aktiver Spieler</p>
                                        <p className="text-2xl font-bold text-purple-400">{currentPlayer?.name}</p>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                {/* Main Area */}
                                <div className="lg:col-span-2">
                                    <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl border border-white/20 min-h-[400px] flex flex-col justify-center">
                                        {!currentCard ? (
                                            isActivePlayer ? (
                                                <button
                                                    onClick={drawCard}
                                                    className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-12 py-6 rounded-2xl font-bold text-2xl hover:shadow-lg transform hover:scale-105 transition mx-auto pulse-animation"
                                                >
                                                    Karte ziehen
                                                </button>
                                            ) : (
                                                <p className="text-white/60 text-center text-xl">
                                                    Warte darauf, dass {currentPlayer?.name} zieht...
                                                </p>
                                            )
                                        ) : (
                                            <div className="space-y-6">
                                                <div className="text-center">
                                                    <span className={`inline-block px-4 py-2 rounded-full text-sm font-bold ${
                                                        currentCard.category === 'white' ? 'bg-gray-400' :
                                                        currentCard.category === 'blue' ? 'bg-blue-500' :
                                                        currentCard.category === 'purple' ? 'bg-purple-500' :
                                                        currentCard.category === 'brown' ? 'bg-amber-700' :
                                                        'bg-gray-900'
                                                    } text-white`}>
                                                        {currentCard.category.toUpperCase()} BELT
                                                    </span>
                                                </div>

                                                <p className="text-2xl md:text-3xl text-white text-center font-medium leading-relaxed px-4">
                                                    "{currentCard.text}"
                                                </p>

                                                {isActivePlayer && activePlayerRating === null && (
                                                    <div className="space-y-4">
                                                        <p className="text-white text-center">Bewerte deine Ehrlichkeit:</p>
                                                        <div className="flex gap-2 md:gap-4 justify-center flex-wrap">
                                                            {[1, 2, 3, 4, 5].map(rating => (
                                                                <button
                                                                    key={rating}
                                                                    onClick={() => submitRating(rating)}
                                                                    className="w-14 h-14 md:w-16 md:h-16 bg-white/10 hover:bg-white/20 border-2 border-white/30 rounded-xl text-white font-bold text-xl md:text-2xl transition transform hover:scale-110"
                                                                >
                                                                    {rating}
                                                                </button>
                                                            ))}
                                                        </div>
                                                        <p className="text-white/60 text-center text-sm">
                                                            1 = Nie | 5 = Absolut
                                                        </p>
                                                    </div>
                                                )}

                                                {!isActivePlayer && activePlayerRating !== null && guesses[myName] === undefined && (
                                                    <div className="space-y-4">
                                                        <p className="text-white text-center">Rate {currentPlayer?.name}s Bewertung:</p>
                                                        <div className="flex gap-2 md:gap-4 justify-center flex-wrap">
                                                            {[1, 2, 3, 4, 5].map(guess => (
                                                                <button
                                                                    key={guess}
                                                                    onClick={() => submitGuess(guess)}
                                                                    className="w-14 h-14 md:w-16 md:h-16 bg-white/10 hover:bg-white/20 border-2 border-white/30 rounded-xl text-white font-bold text-xl md:text-2xl transition transform hover:scale-110"
                                                                >
                                                                    {guess}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {guesses[myName] !== undefined && !allGuessed && (
                                                    <p className="text-green-400 text-center text-lg">
                                                        ‚úì Dein Tipp abgegeben! Warte auf andere...
                                                    </p>
                                                )}

                                                {activePlayerRating !== null && allGuessed && isActivePlayer && (
                                                    <button
                                                        onClick={revealResults}
                                                        className="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-4 rounded-xl font-bold text-xl hover:shadow-lg transform hover:scale-105 transition mx-auto block"
                                                    >
                                                        Ergebnisse anzeigen
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* Challenge Button */}
                                    {currentCard && activePlayerRating !== null && !isActivePlayer && !challengeActive && (
                                        <button
                                            onClick={initiateChallenge}
                                            className="w-full mt-4 bg-gradient-to-r from-red-500 to-orange-500 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transform hover:scale-105 transition"
                                        >
                                            üö® Diese Bewertung anfechten
                                        </button>
                                    )}
                                </div>

                                {/* Scoreboard */}
                                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
                                    <h3 className="text-xl font-bold text-white mb-4">Trust Points</h3>
                                    <div className="space-y-3">
                                        {players
                                            .sort((a, b) => (scores[b.name] || 0) - (scores[a.name] || 0))
                                            .map((player, i) => (
                                                <div
                                                    key={player.id}
                                                    className={`p-3 rounded-lg ${
                                                        player.name === currentPlayer?.name
                                                            ? 'bg-purple-500/30 border border-purple-500'
                                                            : 'bg-white/5'
                                                    }`}
                                                >
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <span className="text-white font-medium">
                                                                {i + 1}. {player.name}
                                                            </span>
                                                            {player.name === myName && (
                                                                <span className="ml-2 text-purple-400 text-xs">(Du)</span>
                                                            )}
                                                            {guesses[player.name] !== undefined && player.name !== currentPlayer?.name && (
                                                                <span className="ml-2 text-green-400 text-xs">‚úì</span>
                                                            )}
                                                        </div>
                                                        <span className="text-2xl font-bold text-purple-400">
                                                            {scores[player.name] || 0}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                    </div>

                                    <button
                                        onClick={resetGame}
                                        className="w-full mt-6 text-white/60 hover:text-white text-sm transition"
                                    >
                                        Spiel beenden
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Reveal Modal */}
                        {showReveal && (
                            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                                <div className="bg-gradient-to-br from-purple-600 to-pink-600 rounded-3xl p-8 md:p-12 max-w-2xl w-full shadow-2xl">
                                    <h2 className="text-3xl md:text-4xl font-bold text-white mb-8 text-center">Ergebnisse!</h2>
                                    
                                    <div className="bg-white/20 rounded-2xl p-8 mb-8">
                                        <p className="text-white/80 text-center mb-4">
                                            {currentPlayer?.name}s wahre Bewertung:
                                        </p>
                                        <p className="text-7xl md:text-8xl font-bold text-white text-center bounce-animation">
                                            {activePlayerRating}
                                        </p>
                                    </div>

                                    <div className="space-y-3">
                                        {Object.entries(guesses).map(([name, guess]) => {
                                            const diff = Math.abs(guess - activePlayerRating);
                                            const points = diff === 0 ? 3 : diff === 1 ? 2 : diff === 2 ? 1 : 0;
                                            
                                            return (
                                                <div key={name} className="bg-white/10 rounded-lg p-4 flex justify-between items-center">
                                                    <div>
                                                        <span className="text-white font-medium">{name}</span>
                                                        <span className="text-white/60 ml-2">tippte {guess}</span>
                                                    </div>
                                                    <span className={`font-bold text-lg ${
                                                        points === 3 ? 'text-green-400' :
                                                        points === 2 ? 'text-yellow-400' :
                                                        points === 1 ? 'text-orange-400' :
                                                        'text-red-400'
                                                    }`}>
                                                        +{points} Pkt.
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Challenge Modal */}
                        {challengeActive && (
                            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                                <div className="bg-gradient-to-br from-red-600 to-orange-600 rounded-3xl p-8 md:p-12 max-w-2xl w-full shadow-2xl shake-animation">
                                    <h2 className="text-3xl md:text-4xl font-bold text-white mb-4 text-center">
                                        üö® ANFECHTUNG!
                                    </h2>
                                    <p className="text-white/90 text-center mb-8 text-lg">
                                        Glaubst du {currentPlayer?.name}s Bewertung von {activePlayerRating}?
                                    </p>

                                    {challengeVotes[myName] === undefined ? (
                                        <div className="flex gap-4 flex-col md:flex-row">
                                            <button
                                                onClick={() => voteChallenge('believe')}
                                                className="flex-1 bg-green-500 text-white px-8 py-6 rounded-xl font-bold text-xl hover:shadow-lg transform hover:scale-105 transition"
                                            >
                                                ‚úì Glaub es
                                            </button>
                                            <button
                                                onClick={() => voteChallenge('challenge')}
                                                className="flex-1 bg-red-700 text-white px-8 py-6 rounded-xl font-bold text-xl hover:shadow-lg transform hover:scale-105 transition"
                                            >
                                                ‚úó Anfechten!
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="text-center">
                                            <p className="text-white text-xl">Stimme abgegeben!</p>
                                            <p className="text-white/60 mt-4">
                                                {Object.keys(challengeVotes).length} / {players.length - 1} Stimmen
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // Render End Game
            if (screen === 'end') {
                const sortedPlayers = [...players].sort((a, b) => (scores[b.name] || 0) - (scores[a.name] || 0));
                const winner = sortedPlayers[0];

                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-4xl w-full">
                            <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 md:p-12 shadow-2xl border border-white/20 fade-in">
                                <div className="text-center mb-8">
                                    <h1 className="text-6xl md:text-7xl mb-4">üèÜ</h1>
                                    <h2 className="text-4xl md:text-5xl font-bold text-white mb-8">Spiel vorbei!</h2>
                                    
                                    <div className="bg-gradient-to-r from-purple-500/30 to-pink-500/30 rounded-xl p-8 mb-8 border border-purple-500/50">
                                        <p className="text-white/80 mb-2">Gewinner</p>
                                        <p className="text-4xl md:text-5xl font-bold text-white">{winner?.name}</p>
                                        <p className="text-3xl text-purple-400 mt-4">{scores[winner?.name]} Trust Points</p>
                                    </div>
                                </div>

                                <div className="space-y-3 mb-8">
                                    <h3 className="text-2xl font-bold text-white text-center mb-4">Finale Platzierung</h3>
                                    {sortedPlayers.map((player, i) => (
                                        <div key={player.id} className="bg-white/5 rounded-lg p-4 flex justify-between items-center">
                                            <div className="flex items-center gap-4">
                                                <span className="text-2xl md:text-3xl font-bold text-white/40">#{i + 1}</span>
                                                <span className="text-lg md:text-xl font-medium text-white">{player.name}</span>
                                            </div>
                                            <span className="text-2xl font-bold text-purple-400">
                                                {scores[player.name] || 0}
                                            </span>
                                        </div>
                                    ))}
                                </div>

                                <button
                                    onClick={resetGame}
                                    className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-12 py-4 rounded-xl font-bold text-xl hover:shadow-lg transform hover:scale-105 transition"
                                >
                                    Nochmal spielen
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        // Render App
        ReactDOM.render(<ConfessionPoker />, document.getElementById('root'));
    </script>

    <!-- Performance Optimizer - Load First -->
<script src="js/performance-optimizer.min.js"></script>
<!-- TAP-IN Utilities -->
<script src="js/shared-utilities.js"></script>
<script src="js/global-error-handler.min.js"></script>
<script src="js/storage-health.min.js"></script>
    <!-- TAP-IN Core Modules -->
    <script src="js/language-switcher.min.js"></script>
    <script src="js/meta-tags-manager.js"></script>
    <script src="js/achievement-badges.js"></script>
    <script src="js/structured-data.js"></script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('New service worker available');
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        // Silent fail - not critical
                    });
            });
        }
    </script>
    <script src="js/pwa-install-prompt.js"></script>

    <!-- Screen Reader Enhancements for Accessibility -->
    <script src="js/screen-reader-enhancements.js" defer></script>
</body>
</html>
